<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Singapore's 14th Parliament</title>
<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
<link href="https://fonts.googleapis.com/css?family=Open+Sans|Playfair+Display&display=swap" rel="stylesheet">
<script src='//unpkg.com/d3@5.0.0/dist/d3.min.js'></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Turf.js/5.1.5/turf.min.js"></script>
<script src='https://unpkg.com/intersection-observer@0.5.1/intersection-observer.js'></script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/scrollama/2.1.2/scrollama.min.js'></script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/stickyfill/2.1.0/stickyfill.min.js'></script>
<script src="https://cdn.jsdelivr.net/npm/vega@5.17.0"></script>
<script src="https://cdn.jsdelivr.net/npm/vega-lite@4.17.0"></script>
<script src="https://cdn.jsdelivr.net/npm/vega-embed@6.12.2"></script>
<style>
  body { 
    margin: 0; 
    padding: 0; 
    font-family: 'Open Sans', sans-serif; 
    width: 100vw;
    height: 100vh;
    position: relative;
/*    background-image:
      radial-gradient(
        circle closest-side,
        white,
        gainsboro
      );*/
  }
  .panel {
    position: -webkit-sticky;
    position: sticky;
    -webkit-transform: translate3d(0, 0, 0);
    -moz-transform: translate3d(0, 0, 0);
    transform: translate3d(0, 0, 0);
    top: 20px;
    left: 80px;
    display: flex;
    flex-wrap: wrap;
    width: 400px;
    display: none;
  }
  .div-legend {
    position: -webkit-sticky;
    position: sticky;
    -webkit-transform: translate3d(0, 0, 0);
    -moz-transform: translate3d(0, 0, 0);
    transform: translate3d(0, 0, 0);
    top: 92vh;
    left: 95vw;
    width: 150px;
    z-index: 2;
    display: none;
  }

  .btn {
    color: black;
    background: transparent; 
    border: 2px solid black; 
    border-radius: 6px; 
    padding: 8px 16px;
    text-align: center;
    display: inline-block;
    font-size: 0.8em;
    margin: 4px 2px;
    -webkit-transition-duration: 0.4s; /* Safari */
    transition-duration: 0.4s;
    cursor: pointer;
    text-decoration: none;
    text-transform: uppercase;
  }
  .btn:hover {
      background-color: black;
      color: white;
  }
  .btn:focus {
      background-color: black;
      color: white;
  }
  .tooltip {
    position: sticky;
    top: 67vh;
    left: 29rem;
    display: flex;
    align-items: center;
    justify-content: center;
    width: auto;
    max-width: 400px;
    height: auto;
    opacity: 0;
    background-color: white;
    border: solid;
    border-width: 1px;
    border-radius: 6px;
    padding: 8px;
    z-index: 99;
  }
  .tooltip p {
    font-size: 12px;
    margin: 3px 0px;
  }
  .tooltip h3 {
    margin: 0px 0px 10px 0px;
  }
  .tooltip a {
    font-size: 12px;
    color: navy;
  }
  .tooltip span {
    font-weight: bold;
  }
  .tooltip ul {
    list-style-type: none;
    margin: 0;
    padding: 0;
  }
  .mini-button {
    width: auto;
    font-size: 12px;
    border: 1px solid black;
    border-radius: 6px;
    padding: 2px;    
  }

  .introWrapper {
    position: absolute;
    width: 100vw;
    height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
  }
  .intro {
    display: flex;
    flex-direction: column;
    width: 70%;
    height: 100%;
    align-items: center;
    justify-content: center;
  }
  #scrolly {
    position: absolute;
  }
  article {
    position: relative;
    padding: 0;
    max-width: 26.5rem;
    margin-left: 20px;
    pointer-events: none;
  }
  #chart {
    position: -webkit-sticky;
    position: sticky;
    left: 0;
    width: 100%;
    margin: 0;
    -webkit-transform: translate3d(0, 0, 0);
    -moz-transform: translate3d(0, 0, 0);
    transform: translate3d(0, 0, 0);
    width: 100vw;
    height: 100vh;
  }
  .step {
    margin: 0 auto 2rem auto;
    color: #000;
    background-color: transparent;
    pointer-events: none;
  }
  .step:last-child {
    margin-bottom: 0;
  }
  .step.is-active {
  }
  .step-transparent {
    background-color: transparent !important;
  }
  .step-text {
    font-size: 12px;
    line-height: 200%;
    margin: 3px 0px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    width: auto;
    height: auto;
    opacity: 0.95;
    background-color: white;
    border: solid;
    border-width: 1px;
    border-radius: 6px;
    padding: 8px;
    pointer-events: auto;
  }
</style>
</head>
<body>
  <main>
    <div class='introWrapper'>
      <div class='intro'>
        <div class='header'><h1>Singapore's Members of the 14th Parliament</h1></div>
      </div>
    </div>
    <section id='scrolly'>
      <div id='chart'></div>
      <div class='panel'>
       <h2>Singapore's 14th Parliament</h2>
         <input name="type" 
          type="button" 
          class="btn map-view"
          value="Constituencies"/>
          <input name="type" 
          type="button" 
          class="btn foci-view"
          value="Ministries"/>
          <input name="type" 
          type="button" 
          class="btn party-view"
          value="Party"/>
         <input name="type" 
          type="button" 
          class="btn gender-view"
          value="Gender"/>
          <input name="type" 
          type="button" 
          class="btn ethnicity-view"
          value="Ethnicity"/>
          <input name="type" 
          type="button" 
          class="btn age-view"
          value="Age"/>
          <input name="type" 
          type="button" 
          class="btn scatter-view"
          value="Age vs Terms"/>
          <input name="type" 
          type="button" 
          class="btn tsne-view"
          value="Similarity"/>
      </div>
      <div class='tooltip'></div>
      <div class='div-legend'>
        <input name="type" 
          type="button" 
          class="btn legend-view"
          value="Show Legend"/>
      </div>
      <article>
        <div class='step' data-step='0'>
          <div class='step-text'>
            <p>Singapore's current Prime Minister is Lee Hsien Loong. Even as PM, he has his own constituency to care for and stands for election representing his constituency.</p>
          </div>    
        </div>
        <div class='step' data-step='1'>
          <div class='step-text'>
            <p>The Prime Minister of Singapore chooses the other members of the Cabinet by advising the President.</p>    
          </div> 
        </div>
        <div class='step' data-step='2'>
          <div class='step-text'>
            <h3>Uniquely Singaporean: Group Representation Constituency (GRC)</h3>
            <p>GRC is a type of electoral division or constituency in Singapore in which teams of candidates, instead of individual candidates, compete to be elected into Parliament as the Members of Parliament (MPs) for the constituency. The Government stated that the GRC scheme was primarily implemented to enshrine minority representation in Parliament: at least one of the MPs in a GRC must be a member of the Malay, Indian or another minority community of Singapore. In addition, it was economical for town councils, which manage public housing estates, to handle larger constituencies.</p>
          </div>
        </div>
        <div class='step' data-step='3'>
          <div class='step-text'>
            <h3>Stagnant racial diversity in Parliament</h3>
            <p>Critics disagree with the government's justifications for introducing the GRC scheme, noting that the proportion of minority MPs per GRC has decreased with the advent of five-member and six-member GRCs. By having teams of candidates standing for election for GRCs helmed by senior politicians, the ruling People's Action Party has also used GRCs as a means for bringing first-time candidates into Parliament. Moreover, the GRC scheme is also said to disadvantage opposition parties because it is more difficult for them to find enough candidates to contest GRCs. Furthermore, it is said that the GRC scheme means that electors have unequal voting power, weakens the relationship between electors and MPs, and entrenches racialism in Singapore politics</p>
            <div class='vegaChart' id="vega-ethnicity-vis"></div>
          </div>
        </div>
        <div class='step' data-step='4'>
          <div class='step-text'>
            <h3>A one party state?</h3>
            <p>Singapore has never and will unlikely see a rotation of the ruling party like in Western models of democracy such as United States. Opposition parties contesting have long maintained their position of simply providing a check and balance to the People's Action Party, which has won every election since Singapore gained independence from the British in 1959. The Worker's Party won 4 extra seats in the latest election compared to the previous in 2015. The WP's numbers in parliament are still small and short of the one-third required to break the PAP's parliamentary supermajority, which allows the PAP the ability to amend the Constitution with few other barriers.</p>
            <div class='vegaChart' id="vega-party-vis"></div>
          </div>
        </div>
        <div class='step' data-step='5'>
          <div class='step-text'>
            <h3>Growing participation of women in Singapore politics</h3>
            <p>Traditionally, women in Singapore played a small role in the country's political scene. There were no women in parliament for 14 years from 1970 to 1984. In recent years, while Singapore has seen an increase in female representation in Parliament, there are few women in the Cabinet. On 1 October 2015, Grace Fu was appointed the Minister for Culture, Community and Youth, and Josephine Teo as Minister of Manpower. Both retain their role in the cabinet.</p>
            <div class='vegaChart' id="vega-gender-vis"></div>
          </div>
        </div>
        <div class='step' data-step='6'>
          <div class='step-text'>
           <h3>Young Parliamentarians alongside veterans</h3>
            <p>Heng Swee Keat and Tan See Leng entered Parliament in their 50s, but became ministers in their first term. S. Iswaran and K. Shanmugam are one of the longest serving MPs, with both entering Parliament relatively young. K.Shanmugam entered Parliament when he was just 29 years of age. Amongst the current MPs, only Tin Pei Ling, Raeesah Khan and Nadia Samdin, have been sowrn in as MPs by that age,. Desmond Lee can take pride in being Singapore's youngest Minister, a position he achieved when he was 41 years old.</p>
            <h3>Delay of 3G to 4G Leadership transition</h3>
            <p>It appears that PM Lee had initially meant for 2020 to be the year of transition into the 4G leadership. However, when the new Cabinet line-up was announcted after the latest election, the 3G leadership was still very much in command, with only a reshuffle of the 4G ministers amongst ministries. PM Lee commented that most of the younger ministers came in one or two terms ago, and as such, their exposure in government is not as comprehensive nor as long, compared with the experience of 3G ministers.</p>
          </div>
        </div>
        <div class='step' data-step='7'>
        </div>
        <div class='step' data-step='8'>
          <div class='step-text'>
            <h3>Beyond party affliation, is there diversity in Parliament?</h3>
            <p>Based on the subset of attributes of each MP discussed so far, with the exception of party affliation and constituency representation, I applied a clustering algorithm to group similar MPs, with each attribute (gender, age, ethnicity, number of terms served and ministry currently serving) having equal weight. Some small clusters can be observed, with no large and tight clusters.</p>
          </div>
        </div>
        <div class='step' data-step='9'>
        </div>
      </article>
    </section>
  </main>

<script>

  // Ensure that page is flushed to top everytime a user refreshes the page
  window.onbeforeunload = function () {
    window.scrollTo(0, 0);
  }

  var show_legend = false
  // initialize scrollama
  var scroller = scrollama();

  var main = d3.select('main')
  var scrolly = main.select('#scrolly');
  var chart = scrolly.select('#chart');
  var article = scrolly.select('article');
  var step = article.selectAll('.step');

  var canvasDim = { width: window.innerWidth, height: window.innerHeight}
  var margin = {top: 20, right: 0, bottom: 0, left: 0}
  var width = canvasDim.width - margin.left - margin.right 
  var height = canvasDim.height - margin.top - margin.bottom 

  var svg = chart.append("svg")
      .attr("width", width + margin.left + margin.right)
      .attr("height", height + margin.top + margin.bottom)

  var g = svg.append("g")
      .attr("transform", "translate(" + margin.left + "," + margin.top + ")")

  var map = g.append("g").attr("id", "map")
              .attr("transform", "translate(" + (-width/4) + "," + 0 + ")")

  var bubbles_explore = g.append("g").attr("id", "bubbles_explore")
    .attr("transform", "translate(" + (-width/4) + "," + 0 + ")")

  var svgLegend = g.append("g").attr("id", "legend")
              .attr("transform", "translate(" + (width-330).toString() + "," + (height-260) + ")")

  var centroids = []

  let radius = 17.5

  let forceCollide = d3.forceCollide()
      .radius(function(d) { return radius + 5; })

  var category = {
   'Group 1': ["Defence", "Foreign Affairs"],
   'Group 2': ["Health"], 
   'Group 3': ["Transport"], 
   'Group 4': ["Sustainability and the Environment", 
               "Social & Family Development", 
               "Communications & Information", 
               "Culture, Community and Youth", 
               "Education"],
   'Group 5': ["Trade and Industry", "Manpower", "Finance"], 
   'Group 6': ["PMO"],
   'Group 7': ["Law", "National Development", "Home Affairs"] 
  }

  var categoryList = Object.values(category).flat()

  var color = {
    'Group 1' : "#f94144", 
    "Group 2" : "#f20089", 
    "Group 3": "#f8961e", 
    "Group 4" : "#ffd500", 
    "Group 5" : "#90be6d", 
    "Group 6" : "#2d00f7", 
    'Group 7' : "#7209b7"
  }

  var widths = {
    'Prime Minister' : 6, 
    "Deputy Prime Minister" : 5.5,
    "Senior Minister" : 5.5,
    "Minister" : 5,  
    "Senior Minister Of State": 3.5, 
    "Minister Of State" : 3, 
    "Senior Parliamentary Secretary" : 1.5,
    "Parliamentary Secretaries" : 1
  }

  var colorScale = d3.scaleOrdinal()
    .domain(Object.keys(color))
    .range(Object.values(color))

  var widthScale = d3.scaleOrdinal()
    .domain(Object.keys(widths))
    .range(Object.values(widths))

  drawLegend(svgLegend)

  /////////////////////// Draw Legend //////////////////////////
  function drawLegend(svgLegend){

    svgLegend.attr("opacity", 0)

    svgLegend.append('text')
      .attr("transform", 'translate(0,-30)')
      .attr('font-weight', 'bold')
      .text('Ministries')

    var legend = svgLegend.selectAll('.legend')
      .data(Object.entries(color))
      .enter().append('g')
        .attr("class", "legend")
        .attr("transform", function (d, i) {return "translate(0," + getY(i)+ ")"})
        
    legend.append("circle")
        .attr("class", "legend-node")
        .attr("cx", -20)
        .attr("cy", -10/2)
        .attr("r", 10)
        .style("fill", d=>colorScale(d))

    legend.append("text")
        .attr("class", "legend-text")
        .style("fill", "black")
        .style("font-size", 12)
        .text(d=> category[d[0]])
        .call(wrap, 300);

    function getY(i){
      if(i<=3){
        return i*25
      } else if(i==3){
        return i*50
      } else {
        return (i*25) + 30
      }
    }
  }


  /////////////////////// Draw Map (with labels) //////////////////////////
  function drawMap(data, projection) {

    var path = d3.geoPath()
       .projection(projection)

    // draw a path for each feature/country
    map
       .selectAll("path")
       .data(data)
       .enter().append("path")
       .attr("d", path)
       .attr('id', d=> 'map-' + findID(d))
       .attr("class", "constituencies")
       .attr('fill', 'transparent')
       .attr('stroke', 'black')
       .attr('stroke-width', 0.2)
       .attr('stroke-opacity', 0.5)
       .attr("transform", "translate(" + 200 + "," + 20 + ")")

    map
       .selectAll("text")
       .data(data)
       .enter().append("text")
       .attr('id', d=> 'map-label-' + findID(d))
       .attr("class", "constituencies-labels")
       .attr("transform", "translate(" + ((width/2)+(width/4)).toString() + "," + 20 + ")")
       // .attr("transform", function(d) {
       //    let centroid = path.centroid(d)
       //    return (
       //       "translate(" + centroid[0] + "," + centroid[1] + ")" // centroid of countries
       //    );
       // })
       .attr('text-anchor', 'middle')
       .attr('font-weight', 'bold')
       .attr('fill', 'black')
       .attr('opacity', 0)
       .text(d=>d.properties['Name'])

    d3.selectAll("path.constituencies")
     .on('mouseover', function(d){
        d3.select('#map-label-'+ findID(d)).attr('opacity', 1)
        d3.select(this).attr('stroke-opacity', 0.5)
     })
     .on('mouseout', function(d){
        d3.select('#map-label-'+ findID(d)).attr('opacity', 0)
        d3.select(this).attr('stroke-opacity', 0.5)
        d3.select(".tooltip").style("opacity", 0)

     })

  }

  function simulateStatic(nodes, simulation, opacity) {

    simulation.stop();

    while (simulation.alpha() > simulation.alphaMin()) {
      simulation.tick();
    }

    updateCircles(nodes, 400, opacity)

  }

  /////////////////////// Update circle (with image) location and attributes //////////////////////////
  function updateCircles(data, DELAY, opacity){

    circles = bubbles_explore.selectAll("g.nodegroup").data(data, (d,i)=>d['key'])

    let entered_circles = circles.enter().append("g")
      .attr('class', 'nodegroup')
      .attr('id', d => 'node-' + d.Title_1.trim().replaceAll(' ', '_'))
      .attr('transform', d=> { return 'translate(' + d.x + "," + d.y + ")" })
      .style('opacity', opacity)
      .attr('cursor', 'pointer')
      .each(function (d) {
        NodePieBuilder.drawNodePie(d3.select(this), d.pieChart, {
          radius: radius + widthScale(d.Title_1)
        });
      })
      .on('mouseover', function(d){

        let items = []
        if(d.Ministry_1){ items.push(d.Ministry_1) }
        if(d.Ministry_2){ items.push(d.Ministry_2) }
        if(d.Ministry_3){ items.push(d.Ministry_3) }

        let keywordList = "<span>";
        for(var i = 0; i < items.length; i++){
          keywordList += "<span class='mini-button'>" + items[i] + "</span>"
        }
        keywordList += "</span>";

        let ID = d['Division'].replace(' ', '_').toUpperCase()
        d3.select('#map-label-'+ ID).attr('opacity', 1)
        d3.select('#map-'+ ID).attr('stroke-opacity', 1)
        d3.select(".tooltip")
          .html(
            "<div style='padding: 10px'><img width='100px' src=" + `./images/${d.newName}.jpg` + "></div><div>" + 
            "<h3>" + d.Name + "</h3><p>" + 
            "Title: <span>" + d.Title_1 + "</span></p><p>" +
            "Party: <span>" + d.Party + "</span></p><p>" + 
            "Constituency: <span>" + d.Division + "</span></p><p>" + 
            "Gender: <span>" + d.Gender + "</span></p><p>" + 
            "Age: <span>" + d.Age + "</span></p><p>" + 
            "Ethnicity: <span>" + d.Ethnicity + "</span></p><p>" +
            "No. of terms: <span>" + d.sessions_group + "</span></p><p>" + 
            "Portfolio: " + keywordList 
          )
          //.style("left", (d3.event.clientX + 25).toString() + "px")
          //.style("top", (d3.event.clientY - 70).toString() + "px")
          .style("opacity", 1)
      })
      .on('mouseout', function(d){
        let ID = d['Division'].replace(' ', '_').toUpperCase()
        d3.select('#map-label-'+ ID).attr('opacity', 0)
        d3.select('#map-'+ ID).attr('stroke-opacity', 0)
        d3.select(".tooltip").style("opacity", 0)
      })

    const imageAccessor = d => `./images/${d.newName}.jpg`
    const fillAccessor = d => `url(#image-${d.newName})`

    const defs = entered_circles.append("defs");

    defs
      .append('pattern')
        .attr("id", d => "image-" + d['newName'])
        .attr("width", 1)
        .attr("height", 1)
      .append("svg:image")
        .attr("xlink:href", d => imageAccessor(d))
        .attr("width", 35)
        .attr("preserveAspectRatio", "xMidYMid slice")
        
    entered_circles.append("circle").attr('class', 'bubble')
      .attr('r', radius)
      .attr('stroke', 'black')
      .attr('stroke-width', d => d['Type.1'] == 'Cabinet' ? '0px' : '1px')
      .attr('fill', d => fillAccessor(d))
      .style('opacity', 0)

    circles.merge(entered_circles)        
      .transition().ease(d3.easeCubicOut).duration(750).delay(DELAY)
      .attr('transform', d=> { return 'translate(' + d.x + "," + d.y + ")" })
      .style('opacity', opacity)

    circles.merge(entered_circles).selectAll('.bubble')
      .transition().duration(750)
      .style('opacity', 1)

    circles.exit()
      .transition().duration(250)
      .style('opacity', 0)
      .remove()
    
  }

  function drawClustersOnMap(data, projection, coords, opacity) {

    data.forEach(d=>{
      let point = projection([+d[coords[0]], +d[coords[1]]])
      d.x = point[0] + 200
      d.y = point[1]
    })

    var simulation = d3.forceSimulation()
      .nodes(data)
      .force("collide", forceCollide)
      .force('charge', d3.forceManyBody().strength(-10))
      .force("x", d3.forceX(function (d) { return d.x }).strength(1))
      .force("y", d3.forceY(function (d) { return d.y }).strength(1))

    simulateStatic(data, simulation, opacity)

  }

  function drawFocisMinistry(data) {

    var Foci_new = onFociCountChange(null, categoryList, 4.9)
    var FociText = onFociCountChange(null, categoryList, 6.3)

    let dataFiltered = data.filter(d=>d['Type.1'] == 'Cabinet')
    let nodes = createNodes(Foci_new, dataFiltered) 
    updateTexts(FociText) 

    var simulation = d3.forceSimulation()
      .nodes(nodes)
      .force("collide", forceCollide)
      .force('charge', d3.forceManyBody().strength(-10))
      .force("x", d3.forceX(function (d) { return d.x+width/4 }))
      .force("y", d3.forceY(function (d) { return d.y }))

    simulateStatic(nodes, simulation, 1)

    // setTimeout(function(){

    //   let nodes = createNodes(Foci_new, data) 

    //   simulation = d3.forceSimulation()
    //     .nodes(nodes)
    //     .force("collide", forceCollide)
    //     .force('charge', d3.forceManyBody().strength(-10))
    //     .force("x", d3.forceX(function (d) { return d.x }))
    //     .force("y", d3.forceY(function (d) { return d.y }))

    //   simulateStatic(nodes, simulation)

    // }, 3000)

    ////////////////////////////////// Create nodes //////////////////////////////
    function createNodes(focis, data) {

      var n = []
      data.map((d,i)=> {
        let F = focis.find(f=>f.key == d.Ministry_1) || [{x: width/2, y: height/2, color: "#E47D06"}]
        n.push({
          ...d,
          key: d['newName'] + '-' + d.Ministry_1, // unique index for each node
          x: F.x,
          y: F.y,
        })
      })
      let data_2 = data.filter(d=>d.Ministry_2)
      data_2.map((d,i)=> {
        let F = focis.find(f=>f.key == d.Ministry_2) || [{x: width/2, y: height/2, color: "#E47D06"}]
        n.push({
          ...d,
          key: d['newName'] + '-' + d.Ministry_2, // unique index for each node
          x: F.x,
          y: F.y
        })
      })
      let data_3 = data.filter(d=>d.Ministry_3)
      data_3.map((d,i)=> {
        let F = focis.find(f=>f.key == d.Ministry_3) || [{x: width/2, y: height/2, color: "#E47D06"}]
        n.push({
          ...d,
          key: d['newName'] + '-' + d.Ministry_3, // unique index for each node
          x: F.x,
          y: F.y
        })
      })

      return n

    }

  }

  function drawCategory(data, col, categoryList) {

    ///////////////////////////////////////////////////////////////////////////
    ///////////////////////////// Create scales ///////////////////////////////
    ///////////////////////////////////////////////////////////////////////////
    let dataGrp = d3.nest()
      .key(d=>d[col])
      .entries(data)

    var Foci_new = onFociCountChange(dataGrp, categoryList, 6.8)
    var FociText = onFociCountChange(dataGrp, categoryList, 6.8)

    let nodes = createNodes(Foci_new, data, col) 

    updateTexts1(FociText) 

    var simulation = d3.forceSimulation()
      .nodes(nodes)
      .force("collide", forceCollide)
      .force('charge', d3.forceManyBody().strength(-10))
      .force("x", d3.forceX(function (d) { return d.x+width/3+80 }))
      .force("y", d3.forceY(function (d) { return d.y }))

    simulateStatic(nodes, simulation, 1)

    ////////////////////////////////// Create nodes //////////////////////////////
    function createNodes(focis, data, col) {

      var n = []
      data.map((d,i)=> {
        let F = focis.find(f=>f.key == d[col]) || [{x: width/2, y: height/2, color: "#E47D06"}]
        n.push({
          ...d,
          key: d['newName'] + '-' + d.Ministry_1, // unique index for each node
          x: F.x,
          y: F.y,
        })
      })
      return n

    }
  }

  //Load data
  Promise.all([
    d3.csv("./data/mps_constituencies.csv"),
    d3.json("./data/electoral-boundary-2020.json"),
    d3.json("./data/GE2020.json")
  ]).then(function(data) {
    
    let data0 = data[0]
    let data1 = data[1]
    let data2 = data[2]

    data0.forEach(d=>{
      d.key = d['newName'] + '-' + d.Ministry_1
      d.age_group = getAgeGrp(+d.Age)
      d.sessions_group = getSessionsGrp(+d.Years_In_Politics)
      if(d.Ministry_1 && d.Ministry_2 && d.Ministry_3){
        d.pieChart = [
          {group: getKeyByValue(category, d.Ministry_1), percent: 100/3},
          {group: getKeyByValue(category, d.Ministry_2), percent: 100/3},
          {group: getKeyByValue(category, d.Ministry_3), percent: 100/3}
        ]
      } else if (d.Ministry_1 && d.Ministry_2){
        d.pieChart = [
          {group: getKeyByValue(category, d.Ministry_1), percent: 100/2},
          {group: getKeyByValue(category, d.Ministry_2), percent: 100/2}
        ]
      } else if(d.Ministry_1){
        d.pieChart = [
          {group: getKeyByValue(category, d.Ministry_1), percent: 100}
        ]
      } else {
        d.pieChart = []
      }
    })

    let fixed = data1.features.map(function(f) {
      return turf.rewind(f,{reverse:true});
    })

    let projection = d3.geoMercator()
      .fitSize([width*1.2,height*1.2],{"type": "FeatureCollection","features":fixed})

    let fixed2 = data2.features.map(function(f) {
      return turf.rewind(f,{reverse:true});
    })

    let projection2 = d3.geoMercator()
      .fitSize([width*1.2,height*1.2],{"type": "FeatureCollection","features":fixed2})
    
    // 1. force a resize on load to ensure proper dimensions are sent to scrollama
    handleResize();

    // 2. setup the scroller passing options
    //    this will also initialize trigger observations
    // 3. bind scrollama event handlers (this can be chained like below)
    scroller.setup({
      step: '#scrolly article .step',
      offset: 0.25,
      debug: false,
      progress: true,
      threshold: 1
    })
    .onStepEnter(handleStepEnter)

    // setup resize event
    window.addEventListener('resize', handleResize);

    // render on initial page load
    //drawMap(fixed, projection)
    //drawClustersOnMap(data0, projection
    drawClustersOnMap(data0, projection2, ['lat_ward', 'lon_ward'], 0.3)

    d3.select(".foci-view")
      .on("click", function() {
        clear()
        drawFocisMinistry(data0)
      })

    d3.select(".ethnicity-view")
      .on("click", function() {
        clear()
        drawCategory(data0, 'Ethnicity', ['Malay', 'Eurasian', 'Chinese', 'Indian']) 
      })

    d3.select(".gender-view")
      .on("click", function() {
        clear()
        drawCategory(data0, 'Gender', ['Female', 'Male']) 
      })

    d3.select(".party-view")
      .on("click", function() {
        clear()
        drawCategory(data0, 'Party', ["People's Action Party", "Workers' Party"]) 
      })

    d3.select(".age-view")
      .on("click", function() {
        clear()
        let options = {
          radius: radius*1.25,
          tilesPerRow: 3,
          width: width,
          height: height-radius,
          leftBuffer: 0,
          bottomBuffer: 0,
          category: {'color': undefined, 'sort_list': d3.range(d3.extent(data, d=>d.age)), 'sort_category': 'Age'}
        }
        let nodes = createDots(data0, 'bar', 'age_group', "", ['Less than 35', '35 - 40', '40 - 45', '45 - 50', '50 - 55', '55 - 60', '60 - 65', 'More than 65'], "", options)
        nodes.dots.forEach(d=>{
          d.x = d.x + width/4
        })
        updateCircles(nodes.dots, (d,i)=>50*i, 1)
        updateTexts1(nodes.labels.filter(d=>d.type === 'xaxis_label')) 
      })

    d3.select(".scatter-view")
      .on("click", function() {
        clear()
        let data = createScatter(data0, {x: 'Years_In_Politics', y: 'Age', rangeX: [width/3+40, width+width/6], rangeY: [height-40, 20], show_axis: true})
        var simulation = d3.forceSimulation()
          .nodes(data)
          .force("collide", forceCollide)
          .force('charge', d3.forceManyBody().strength(-10))
          .force("x", d3.forceX(function (d) { return d.x }).strength(1))
          .force("y", d3.forceY(function (d) { return d.y }).strength(1))

        simulateStatic(data, simulation, 1) 
      })

    d3.select(".map-view")
      .on("click", function() { 
        clear()
        drawMap(fixed, projection)
        drawClustersOnMap(data0, projection, ['lat', 'long'], 1)
      })
   
    d3.select(".tsne-view")
      .on("click", function() {
        clear()
        let data = createScatter(data0, {x: 'X', y: 'Y', rangeX: [width/4+40, width+width/6], rangeY: [height-40, 40], show_axis: false})
        updateCircles(data, 400, 1)
      })

    d3.select(".legend-view")
      .on("click", function() {
        show_legend = !show_legend
        if(show_legend){
          d3.selectAll("#legend").attr('opacity', 1)
        } else {
          d3.selectAll("#legend").attr('opacity', 0)
        }
      })

    function clear() {
      map.selectAll('path').remove()
      map.selectAll(".constituencies-labels").remove()
      bubbles_explore.selectAll("text.fociText").remove()
      bubbles_explore.selectAll(".scatter_x_axis").remove()
      bubbles_explore.selectAll(".scatter_y_axis").remove()
    }

    ///////////////////////////////////////////////////////////////////////////
    ////////////////////////// Scrollama event handlers ///////////////////////
    ///////////////////////////////////////////////////////////////////////////
    function handleResize() {

      // 1. update height of step elements
      var stepH = Math.floor(window.innerHeight);
      step.style('height', stepH + 'px');
      var figureHeight = window.innerHeight
      var figureMarginTop = (window.innerHeight - figureHeight) / 2  
      chart
        .style('height', figureHeight + 'px')
        .style('top', figureMarginTop + 'px');
      // 3. tell scrollama to update new element dimensions
      scroller.resize();

    }

    function handleStepEnter(response) {

      // response = { element, direction, index }
      // fade in current step
      step.classed('is-active', function (d, i) {
          return i === response.index;
      })

      if (response.index === 0) { 

        d3.selectAll(".div-legend").style('display', 'none')
        clear()
        drawMap(fixed2, projection2)
        drawClustersOnMap(data0, projection2, ['lat_ward', 'lon_ward'], 0.3)

        scroller.onStepProgress(handleStepProgress)

      } else if (response.index === 1) { 

        d3.selectAll(".div-legend").style('display', 'block')
        d3.selectAll('#node-Member_of_Parliament').style('opacity', 1)
        
      } else if (response.index === 2) { 

        clear()
        drawMap(fixed, projection)
        drawClustersOnMap(data0, projection, ['lat', 'long'], 1)

      } else if (response.index === 3) { 

        clear()
        drawCategory(data0, 'Ethnicity', ['Malay', 'Eurasian', 'Chinese', 'Indian']) 

      } else if (response.index === 4) { 

        clear()
        drawCategory(data0, 'Party', ["People's Action Party", "Workers' Party"]) 

      } else if (response.index === 5) {

        clear()
        drawCategory(data0, 'Gender', ['Female', 'Male']) 

      } else if (response.index === 6) { 

        clear()
        let data = createScatter(data0, {x: 'Years_In_Politics', y: 'Age', rangeX: [width/3+40, width+width/6], rangeY: [height-40, 20], show_axis: true})
        var simulation = d3.forceSimulation()
          .nodes(data)
          .force("collide", forceCollide)
          .force('charge', d3.forceManyBody().strength(-10))
          .force("x", d3.forceX(function (d) { return d.x }).strength(1))
          .force("y", d3.forceY(function (d) { return d.y }).strength(1))

        simulateStatic(data, simulation, 1) 

      } else if (response.index === 8) { 

        clear()
        let data = createScatter(data0, {x: 'X', y: 'Y', rangeX: [width/4+40, width+width/6], rangeY: [height-40, 40], show_axis: false})
        updateCircles(data, 400, 1)

        d3.selectAll('.panel').style('display', 'none')
        //d3.selectAll("#legend").attr('opacity', 0)

      } else if (response.index === 9) { 

        d3.selectAll('.panel').style('display', 'block')
        //d3.selectAll("#legend").attr('opacity', 1)

      } 
    }

    function handleStepExit(response) {
      response.element.classList.remove('is-active');
    }

    function handleStepProgress(response) {

      if (response.index === 0) {
        if(response.progress > 0.1 & response.progress <= 0.25) {
          d3.selectAll('#node-Prime_Minister').style('opacity', 1)
        } else if(response.progress > 0.25 & response.progress <= 0.5) {
          d3.selectAll('#node-Prime_Minister').style('opacity', 1)
          d3.selectAll('#node-Senior_Minister').style('opacity', 1)
          d3.selectAll('#node-Minister').style('opacity', 1)
        } else if(response.progress > 0.5 & response.progress <= 0.75) {
          d3.selectAll('#node-Prime_Minister').style('opacity', 1)
          d3.selectAll('#node-Senior_Minister').style('opacity', 1)
          d3.selectAll('#node-Minister').style('opacity', 1)
          d3.selectAll('#node-Senior_Minister_of_State').style('opacity', 1)
          d3.selectAll('#node-Minister_of_State').style('opacity', 1)
        } else if(response.progress > 0.75) {
          d3.selectAll('#node-Prime_Minister').style('opacity', 1)
          d3.selectAll('#node-Senior_Minister').style('opacity', 1)
          d3.selectAll('#node-Minister').style('opacity', 1)
          d3.selectAll('#node-Senior_Minister_of_State').style('opacity', 1)
          d3.selectAll('#node-Minister_of_State').style('opacity', 1)
          d3.selectAll('#node-Senior_Parliamentary_Secretary').style('opacity', 1)
          d3.selectAll('#node-Parliamentary_Secretaries').style('opacity', 1)
        } else if(response.progress <= 0.1){
          d3.selectAll('#node-Prime_Minister').style('opacity', 1)
          d3.selectAll('g.nodegroup').style('opacity', 0.3)
        }
      }

    }

  })

///////////////////////////////////////////////////////////////////////////
///////////////////////////// Helper functions ////////////////////////////
///////////////////////////////////////////////////////////////////////////
function getAgeGrp(d){
  if(d<=35){
    return 'Less than 35'
  } else if(d>35 && d<=40){
    return '35 - 40'
  } else if(d>40 && d<=45){
    return '40 - 45'
  } else if(d>45 && d<=50){
    return '45 - 50'
  } else if(d>50 && d<=55){
    return '50 - 55'
  } else if(d>55 && d<=60){
    return '55 - 60'
  } else if(d>60 && d<=65){
    return '60 - 65'
  } else if(d>65){
    return 'More than 65'
  }
}

function getSessionsGrp(d){
  if(d==0){
    return '1'
  } else if(d>0 && d<=5){
    return '2'
  } else if(d>5 && d<=9){
    return '3'
  } else if(d>9 && d<=14){
    return '4'
  } else if(d>14 && d<=19){
    return '5'
  } else if(d>19){
    return 'More than 5'
  } 
}

function createScatter(data, attr) {

  let xScale = d3.scaleLinear()
      .range(attr['rangeX'])
      .domain(d3.extent(data, function(d) { return +d[attr['x']]; }))

  let yScale = d3.scaleLinear()
      .range(attr['rangeY'])
      .domain(d3.extent(data, function(d) { return +d[attr['y']]; }))

  data.forEach(d=>{
    d.x = xScale(+d[attr['x']])
    d.y = yScale(+d[attr['y']])
  })

  if(attr['show_axis']){

    let xAxis = d3.axisBottom(xScale);
    let yAxis = d3.axisLeft(yScale);

    bubbles_explore.append("g")
        .attr("class", "scatter_x_axis")
        .attr("transform", `translate(0,${height-30})`)
        .call(xAxis)
      .append("text")
        .attr("class", "label")
        .attr("x", ((width-20+width/4)-(width/3+20)))
        .attr("y", 20)
        .attr('fill', 'black')
        .style("text-anchor", "middle")
        .text("Number of terms");

    bubbles_explore.append("g")
        .attr("class", "scatter_y_axis")
        .attr("transform", `translate(${40+width/4},0)`)
        .call(yAxis)
      .append("text")
        .attr("class", "label")
        .attr("transform", `translate(${-20},${height/2})rotate(-90)`)
        .attr('fill', 'black')
        .attr("dy", ".71em")
        .style("text-anchor", "middle")
        .text("Age")

  }

  return data
}

function updateTexts(focis) {

  texts = bubbles_explore.selectAll("text.fociText").data(focis, (d,i)=>d['key'])

  let entered_texts = texts.enter().append("text")
    .attr('class', 'fociText')
    .attr('transform', d=> { return 'translate(' + (d.x+width/4).toString() + "," + d.y + ")" })
    .attr('text-anchor', (d,i) => alignTexts(i))
    .attr('fill',  'black')
    .attr('font-size', '12px')
    .style('opacity', 0)
    .text(d=>d['key'])
    .call(wrap, 80);
    
  texts.merge(entered_texts)         
    .transition().duration(750).delay(400)
    .attr('transform', d=> { return 'translate(' + (d.x+width/4).toString() + "," + d.y + ")" })
    .style('opacity', 1)

  texts.exit()
    .transition().duration(750)
    .style('opacity', 0)
    .remove()

  function alignTexts(i){
    if((i>=13 && i<=16) || (i>=0 && i<=3)){
      return 'end'
    } else if(i===4 || i===12){
      return 'middle'
    } else {
      return 'start'
    }
  }

}

function updateTexts1(focis) {

  function getRadius(count){
    return count ? (count < 30 ? (count*radius)/2 : (count*radius/2.5)/2) : 0
  }

  texts = bubbles_explore.selectAll("text.fociText").data(focis, (d,i)=>d['key'])

  let entered_texts = texts.enter().append("text")
    .attr('class', 'fociText')
    .attr('transform', d=> { return 'translate(' + (d.x+width/3+80).toString() + "," + (d.y-getRadius(d.count)).toString() + ")" })
    .attr('text-anchor', 'middle')
    .attr('fill',  'black')
    .attr('font-size', '14px')
    .style('opacity', 0)
    .text(d=>d['key'])
    .call(wrap, 80);
    
  texts.merge(entered_texts)         
    .transition().duration(750).delay(400)
    .attr('transform', d=> { return 'translate(' + (d.x+width/3+80).toString() + "," + (d.y-getRadius(d.count)).toString() + ")" })
    .style('opacity', 1)

  texts.exit()
    .transition().duration(750)
    .style('opacity', 0)
    .remove()

}

////////////////////// Assign focus point of each category //////////////////
function onFociCountChange(data, focis, multiplier) {

    fociCount = focis.length
    foci = {};
    for (let i = 0; i < fociCount; i++) {
        let focus = createFocus(i, focis[i], fociCount, multiplier);
        foci[i] = focus;
    }
    let Foci_new = []
    Object.keys(foci).map(function(key, index) {
       Foci_new.push({
        x: foci[index].x,
        y: foci[index].y,
        key: foci[index].key,
        count: data ? data.find(d=>d.key === foci[index].key).values.length : 0
      })     
    })
    return Foci_new
}

function createFocus(index, key, fociCount, multiplier) {
    let angle = 2 * Math.PI / fociCount * index;
    return {
        key: key,
        index: index,
        angle: angle,
        x: width/multiplier * Math.cos(angle) + width/2,
        y: width/multiplier * Math.sin(angle) + height/2
    };
}

function findID(d){
  return d.properties['Name'].replace(' ', '_').toUpperCase()
  //return d.properties.description.split('<td>')[1].split('</td>')[0]
}

function getKeyByValue(object, value) {
  let key = ""
  let arr = Object.values(object)
  for (i = 0; i < arr.length; i++) {
    if(arr[i].indexOf(value) !== -1){
      key = Object.keys(object).find(k => object[k] === arr[i]);
      break;
    }
  }
  return colorScale(key)
}

function wrap(text, width) {
  text.each(function() {
    var text = d3.select(this),
        words = text.text().split(/\s+/).reverse(),
        word,
        line = [],
        lineNumber = 0,
        lineHeight = 1.2, // ems
        y = text.attr("y"),
        dy = parseFloat(text.attr("dy")) || 0,
        tspan = text.text(null).append("tspan").attr("x", 0).attr("y", y)
    while (word = words.pop()) {
      line.push(word)
      tspan.text(line.join(" "))
      if (tspan.node().getComputedTextLength() > width) {
        line.pop()
        tspan.text(line.join(" "))
        line = [word]
        tspan = text.append("tspan").attr("x", 0).attr("y", `${++lineNumber * lineHeight + dy}em`).text(word)
      }
    }
  })
}

var opt = {"actions":false,
           "renderer": 'svg',
           'theme': 'vox', 
           "padding": {"left": 15, "top": 15, "right": 15, "bottom": 15}
};

var color = ["#f2cc8f","#81b29a","#3d405b","#e07a5f", "#f4f1de", "#cbc0d3"]

var vegaEthnicityVis = {
  "$schema": "https://vega.github.io/schema/vega-lite/v4.json",
  "data": {"url": "data/ethnicity_timeline.csv"},
  "width": 250, "height": 200,
  "layer": [
    {
      "encoding": {
        "x": {
          "field": "Parliament", "type": "quantitative"
        },
        "y": {
          "aggregate": "sum", "field": "value",
          "axis": {"format": "%", "title": null},
          "stack": "normalize"
        },
        "color": {"field":"Ethnicity", "scale": {"range": color}}
      },
      "layer": [
        {
          "mark": "area"
        },
        {
          "selection": {
            "tooltip": {
              "type": "single",
              "nearest": true,
              "on": "mouseover",
              "encodings": [
                "x"
              ],
              "empty": "none"
            }
          },
          "mark": "point",
          "encoding": {
            "opacity": {
              "condition": {
                "selection": "tooltip",
                "value": 1
              },
              "value": 0
            }
          }
        }
      ]
  },
  {
    "transform": [
      {
        "filter": {
          "selection": "tooltip"
        }
      }
    ],
    "layer": [{
      "mark": {
       "type": "rule",
       "color": "gray"
      },
      "encoding": {
        "x": {
          "type": "quantitative",
          "field": "Parliament"
        }
      }
    }, {
      "mark": {
          "type": "text",
          "align": "left",
          "dx": 5,
          "dy": -5
      },
      "encoding": {
        "text": {
          "type": "quantitative",
          "field": "value"
        },
        "color": {
          "type": "nominal",
          "field": "Ethnicity"
        },
        "x": {
          "type": "quantitative",
          "field": "Parliament"
        },
        "y": {
          "aggregate": "sum", "field": "value",
          "axis": {"format": "%", "title": null},
          "stack": "normalize"
        }
      }
    }]
  }]
}


var vegaGenderVis = {
  "$schema": "https://vega.github.io/schema/vega-lite/v4.json",
  "data": {"url": "data/gender_timeline.csv"},
  "width": 250, "height": 200,
  "layer": [
    {
      "encoding": {
        "x": {
          "field": "Parliament", "type": "quantitative"
        },
        "y": {
          "aggregate": "sum", "field": "value",
          "axis": {"format": "%", "title": null},
          "stack": "normalize"
        },
        "color": {"field":"Gender", "scale": {"range": color}}
      },
      "layer": [
        {
          "mark": "area"
        },
        {
          "selection": {
            "tooltip": {
              "type": "single",
              "nearest": true,
              "on": "mouseover",
              "encodings": [
                "x"
              ],
              "empty": "none"
            }
          },
          "mark": "point",
          "encoding": {
            "opacity": {
              "condition": {
                "selection": "tooltip",
                "value": 1
              },
              "value": 0
            }
          }
        }
      ]
  },
  {
    "transform": [
      {
        "filter": {
          "selection": "tooltip"
        }
      }
    ],
    "layer": [{
      "mark": {
       "type": "rule",
       "color": "gray"
      },
      "encoding": {
        "x": {
          "type": "quantitative",
          "field": "Parliament"
        }
      }
    }, {
      "mark": {
          "type": "text",
          "align": "left",
          "dx": 5,
          "dy": -5,
          "format": "%"
      },
      "encoding": {
        "text": {
          "type": "quantitative",
          "field": "value"
        },
        "color": {
          "type": "nominal",
          "field": "Gender"
        },
        "x": {
          "type": "quantitative",
          "field": "Parliament"
        },
        "y": {
          "aggregate": "sum", "field": "value",
          "axis": {"format": "%", "title": null},
          "stack": "normalize"
        }
      }
    }]
  }]
}

var vegaPartyVis = {
  "$schema": "https://vega.github.io/schema/vega-lite/v4.json",
  "data": {"url": "data/party_timeline.csv"},
  "width": 280, "height": 200,
  "mark": {"type": "bar", "cornerRadiusTopLeft": 6, "cornerRadiusTopRight": 6, "tooltip": {"content": "data"}},
  "encoding": {
    "x": {
      "field": "Parliament", 
      "type": "ordinal", "sort": [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14], 
      "axis": {"labelAngle": 0}
    },
    "y": {"field": "value", "type": "quantitative", "axis": {"title": "No. of MPs"}},
    "tooltip": [
      {"field": "Parliament", "type": "quantitative"},
      {"field": "Party", "type": "ordinal"},
      {"field": "value", "type": "quantitative"}
    ],
    "color": {
      "field": "Party", 
      "scale": {"range": color}, 
      "legend": {"direction": "horizontal", "orient": "bottom", "columns": 2}
    },
    "sort": ["People's Action Party", "Workers' Party", 'Barisan Sosialis', 'Independent', 'Singapore Democratic Alliance','Singapore Democratic Party'],

  }
}

vegaEmbed('#vega-ethnicity-vis', vegaEthnicityVis, opt);
vegaEmbed('#vega-party-vis', vegaPartyVis, opt);
vegaEmbed('#vega-gender-vis', vegaGenderVis, opt);
</script>
<script src="./node-pie.js"></script>
<script src="./dotplot.js"></script>
</body>
</html>