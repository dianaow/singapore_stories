<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Singapore's 14th Parliament</title>
<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
<link rel="preconnect" href="https://fonts.gstatic.com">
<link href="https://fonts.googleapis.com/css2?family=Raleway:wght@400;600&family=Playfair+Display:wght@600&display=swap" rel="stylesheet">
<script src='//unpkg.com/d3@5.0.0/dist/d3.min.js'></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Turf.js/5.1.5/turf.min.js"></script>
<script src='https://unpkg.com/intersection-observer@0.5.1/intersection-observer.js'></script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/scrollama/2.1.2/scrollama.min.js'></script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/stickyfill/2.1.0/stickyfill.min.js'></script>
<script src="https://cdn.jsdelivr.net/npm/vega@5.17.0"></script>
<script src="https://cdn.jsdelivr.net/npm/vega-lite@4.17.0"></script>
<script src="https://cdn.jsdelivr.net/npm/vega-embed@6.12.2"></script>
<style>
  body { 
    margin: 0; 
    padding: 0; 
    font-family: 'Playfair Display', sans-serif; 
    width: 100vw;
    height: 100vh;
    position: relative;
    background-color: #fbf5e9;
/*    background-image:
      radial-gradient(
        circle closest-side,
        white,
        gainsboro
      );*/
  }
  h1, h2 {
    font-family: 'Playfair Display', sans-serif;
    text-align: center;
  }
  h3 {
    font-family: 'Playfair Display', sans-serif;
  }
  text{
    font-family: 'Raleway', sans-serif;
    font-weight: 400;
  } 
  p {
    font-family: 'Raleway', sans-serif;
    font-weight: 400;
    font-size: 1.1em;
  }
  h4 {
    font-family: 'Raleway', sans-serif;
    font-weight: 400; 
    font-size: 10px;
  }
  span {
    font-family: 'Raleway', sans-serif;
    font-weight: 600;
  }
  .panel {
    position: -webkit-sticky;
    position: sticky;
    -webkit-transform: translate3d(0, 0, 0);
    -moz-transform: translate3d(0, 0, 0);
    transform: translate3d(0, 0, 0);
    top: 20px;
    left: 30px;
    display: flex;
    flex-wrap: wrap;
    width: 320px;
    display: none;
    background-color: #fbf5e9;
  }
  .div-legend {
    position: -webkit-sticky;
    position: sticky;
    -webkit-transform: translate3d(0, 0, 0);
    -moz-transform: translate3d(0, 0, 0);
    transform: translate3d(0, 0, 0);
    top: 93vh;
    left: 95vw;
    width: 150px;
    z-index: 2;
    display: none;
  }

  .btn {
    color: black;
    background: #fbf5e9; 
    border: 2px solid black; 
    border-radius: 6px; 
    padding: 4px 8px;
    text-align: center;
    display: inline-block;
    font-size: 11px;
    margin: 4px 2px;
    -webkit-transition-duration: 0.4s; /* Safari */
    transition-duration: 0.4s;
    cursor: pointer;
    text-decoration: none;
    text-transform: uppercase;
    font-family: 'Montserrat', sans-serif;
  }
  .btn:hover {
      background-color: black;
      color: white;
  }
  .btn:focus {
      background-color: black;
      color: white;
  }
  .tooltip {
    position: sticky;
    top: 67vh;
    left: 29.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    width: auto;
    max-width: 460px;
    height: auto;
    opacity: 0;
    background-color: white;
    padding: 8px;
    z-index: 99;
    pointer-events: none;
  }
  .tooltip p {
    font-size: 12px;
    margin: 3px 0px;
  }
  .tooltip h3 {
    margin: 0px 0px 10px 0px;
  }
  .tooltip a {
    font-size: 12px;
    color: navy;
  }
  .tooltip span {
    font-weight: bold;
  }
  .tooltip ul {
    list-style-type: none;
    margin: 0;
    padding: 0;
  }
  .mini-button {
    width: auto;
    font-size: 10px;
    border: 1px solid black;
    border-radius: 6px;
    padding: 2px;  
    margin: 2px 2px 6px 0px;  
  }

  .introWrapper {
    position: absolute;
    width: 100vw;
    height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
  }
  .intro {
    display: flex;
    flex-direction: column;
    width: 70%;
    height: 100%;
    align-items: center;
    justify-content: center;
  }
  #scrolly {
    position: absolute;
  }
  article {
    position: relative;
    padding: 0;
    max-width: 27rem;
    margin-left: 20px;
    pointer-events: none;
  }
  #chart {
    position: -webkit-sticky;
    position: sticky;
    left: 0;
    width: 100%;
    margin: 0;
    -webkit-transform: translate3d(0, 0, 0);
    -moz-transform: translate3d(0, 0, 0);
    transform: translate3d(0, 0, 0);
    width: 100vw;
    height: 100vh;
  }
  .step {
    margin: 0 auto 2rem auto;
    color: #000;
    background-color: transparent;
    pointer-events: none;
  }
  .step:last-child {
    margin-bottom: 0;
  }
  .step.is-active {
  }
  .step-transparent {
    background-color: transparent !important;
  }
  .step-text {
    font-size: 12px;
    line-height: 200%;
    margin: 3px 0px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    width: auto;
    height: auto;
    opacity: 0.95;
    background-color: white;
    padding: 8px 20px;
    pointer-events: auto;
  }
  .footer {
    padding: 20px;
    background-color: #fbf5e9;
  }

  .norender {
    display: none;
  }

  /* Medium devices (landscape tablets, 768px and up) */
  @media only screen and (max-width: 1050px) {
    article {
      max-width: 22rem;
    }
  }

  @media screen and (orientation::portrait)
  and (max-device-width: 700px) {
    .introWrapper {
      display: none;
    }
    #scrolly {
      display: none;
    }
    .norender {
      display: block;
    }
  }

  @media screen and (orientation:landscape)
  and (max-device-width: 900px) {
    .introWrapper {
      display: none;
    }
    #scrolly {
      display: none;
    }
    .norender {
      display: block;
    }
  }
</style>
</head>
<body>
  <main>
    <div class='norender'>
      <h3 style="text-align: center; padding: 20px">This visualization is best viewed on screen sizes greater than 700px.</h3>
    </div>
    <div class='introWrapper'>
      <div class='intro'>
        <div class='header'>
        <h1>Beyond party affliation, is there diversity in Parliament?</h1>
        <h3 style="text-align: center">An analysis of Singapore's 14th Parliament</h3>
        </div>
      </div>
    </div>
    <section id='scrolly'>
      <div id='chart'></div>
      <div class='panel'>
        <h2 style='text-align: left'>Singapore's 14th Parliament</h2>
         <input name="type" 
          type="button" 
          class="btn map-view"
          value="Constituencies"/>
          <input name="type" 
          type="button" 
          class="btn foci-view"
          value="Ministries"/>
          <input name="type" 
          type="button" 
          class="btn party-view"
          value="Party"/>
         <input name="type" 
          type="button" 
          class="btn gender-view"
          value="Gender"/>
          <input name="type" 
          type="button" 
          class="btn ethnicity-view"
          value="Ethnicity"/>
          <input name="type" 
          type="button" 
          class="btn age-view"
          value="Age"/>
          <input name="type" 
          type="button" 
          class="btn scatter-view"
          value="Age vs Terms"/>
          <input name="type" 
          type="button" 
          class="btn occupation1-view"
          value="Occupation 1"/>
          <input name="type" 
          type="button" 
          class="btn occupation2-view"
          value="Occupation 2"/>
          <input name="type" 
          type="button" 
          class="btn tsne-view"
          value="Similarity"/>
      </div>
      <div class='tooltip'></div>
      <div class='div-legend'>
        <input name="type" 
          type="button" 
          class="btn legend-view"
          value="Show Legend"/>
      </div>
      <article>

        <div class='step' data-step='0'>
          <div class='step-text'>
            <h2>A brief introduction</h2>
            <p>Since Singapore gained independence from the British in 1963, there have been 14 general elections held. Each candidate represents a constituency and voters can choose who will represent them in Parliament for the next term. Following the 2020 general election, 93 Members of Parliament (MP) were elected to the 14th Parliament. Parliamentary terms last for a maximum of five years, and with each new Parliament, about a quarter of them are new faces.</p>
            <p>Singapore's current Prime Minister (PM) is <span>Lee Hsien Loong</span>. Even as PM, he has his own constituency division to care for and stands for election representing his constituency.</p>
          </div>    
        </div>

        <div class='step' data-step='1'>
          <div class='step-text'>
            <p>The Prime Minister chooses members of the Cabinet by advising the President. The Cabinet is responsible for all government policies and the day-to-day administration of the affairs of state.</p>

            <p>It comprises the Prime Minister, Deputy Prime Ministers, Ministers, Ministers of State and Parliamentary Secretaries of the various ministries. They are <span style="color: #f7524f">Defence, Foreign Affairs</span>, <span style="color: #f8bc2e">Health</span>, <span style="color: #4561cc">Transport</span>, <span style="color: #f8bc2e">Sustainability and the Environment, Social & Family Development, Communications & Information, Culture, Community and Youth, Education</span>, <span style="color: #696969">Trade and Industry, Manpower, Finance</span>, <span style="color: #a71172">Prime Ministers Office</span>, <span style="color: #2b8da5">Law, National Development, Home Affairs</span>.</p>    
          </div> 
        </div>

        <div class='step' data-step='2'>
          <div class='step-text'>
            <h2>Uniquely Singaporean: Group Representation Constituency (GRC)</h2>
            <p>GRC is a type of electoral division or constituency in Singapore in which teams of candidates, instead of individual candidates, compete to be elected into Parliament as the Members of Parliament for the constituency. Each voter of a GRC casts a ballot for a team, and not for individuals. The GRC scheme was brought into existence on 1988.</p>
            <p>There are 31 constituencies in Singapore, comprising 17 GRCs and 14 single-member constituencies (SMCs).</p>
            <p>The original justification of the scheme was to guarantee a minimum representation of minorities in Parliament and ensure that there would always be a multiracial Parliament. At least one of the MPs in a GRC must be a member of the Malay, Indian or another minority community of Singapore. It was also deemed economical for town councils, which manage public housing estates, to handle larger constituencies.</p>
          </div>
        </div>

        <div class='step' data-step='3'>
          <div class='step-text'>
            <h2>Stagnant racial diversity in Parliament</h2>
            <p>Since the introduction of the GRC scheme, the proportion of minority MPs has remained stagnant. Critics note that the scheme may undermine the esteem of minority candidates as they would not be sure if they are elected on their own merit or due to the scheme. One wonders if the slate of candidates at each election would have been more or less diverse without the scheme.</p>
            <p>When compared to the proportion of each race in Singapore’s population, political representation of racial minorities is balanced. In 2019,  <span style="color: #e07a5f">Malays</span> account for <span style="color: #e07a5f; font-weight: 900">15%</span> of the Singapore population, they represent <span style="color: #e07a5f;">12%</span> of the MPs. <span style="color: #3d405b">Indians</span> and <span style="color: #81b29a">minorities of other groups</span> account for <span style="color: #3d405b; font-weight: 900">7.5%</span> and <span style="color: #81b29a; font-weight: 900">1.5%</span> of the population respectively in 2019, they represent <span style="color: #3d405b">10%</span> and <span style="color: #81b29a">2%</span> of MPs respectively.</p>
            <div class='vegaChart' id="vega-ethnicity-vis"></div>
          </div>
        </div>

        <div class='step' data-step='4'>
          <div class='step-text'>
            <h2>Growing participation of women</h2>
            <p>Historically, women in Singapore played a small role in the country's political scene. There were no women in Parliament for 14 years from 1970 to 1984. In recent years, Singapore has seen an increase in female representation in Parliament, but there are only 3 women in the current Cabinet. In 2015, <span>Grace Fu</span> was appointed the Minister for Culture, Community and Youth, and <span>Josephine Teo</span> as Minister of Manpower in 2017. <span>Indranee Rajah</span> spent 4 terms in Parliament before she was appointed a Minister in 2018.</p>
            <div class='vegaChart' id="vega-gender-vis"></div>
          </div>
        </div>

        <div class='step' data-step='5'>
          <div class='step-text'>
           <h2>Young Parliamentarians alongside veterans</h2>
            <p><span>Heng Swee Keat</span> and <span>Tan See Leng</span> entered Parliament in their 50s, but became ministers in their first term. <span>S. Iswaran</span> and <span>K. Shanmugam</span> are one of the longest serving MPs, with both entering Parliament relatively young. <span>K.Shanmugam</span> entered Parliament when he was just 29 years of age. Amongst the current MPs, only <span>Tin Pei Ling</span>, <span>Raeesah Khan</span> and <span>Nadia Samdin</span>, have become MPs by that age. <span>Desmond Lee</span> can take pride in being Singapore's youngest Minister, a position he achieved when he was 41 years old.</p>
          </div>
        </div>

        <div class='step' data-step='6'>
          <div class='step-text'>
           <h2>Public vs private sector</h2>
           <p>In the visual on the right, MPs are grouped according to their first occupation. Tradionally, the ruling party has a preference for candidates with some public sector experience, especially for those earmarked for potential appointments in the Cabinet after being elected. Many senior officials from the military and police force have also entered politics.</p>
          </div>
        </div>

        <div class='step' data-step='7'>
          <div class='step-text'>
           <h2>Diverse pathways to a seat in Parliament</h2>
           <p>MPs are now grouped according to their last held occupation before entering Parliament. Ideally, MPs should offer a wealth of experiences gained from their years of working experience and community involvement. Some MPs have either switched career tracks, or succeeded in climbing up the corporate ladder to senior roles, while making time for community or grassroot work.</p>
          </div>
        </div>

        <div class='step' data-step='8'>
          <div class='step-text'>
            <h2>A one-party political system?</h2>
            <p>Singapore has never and will unlikely see a rotation of the ruling party like in Western models of democracy such as United States. Opposition parties contesting have long maintained their position of simply providing a check and balance to the People's Action Party, which has won every election since Singapore gained independence from the British in 1959.</p> 
            <p>The Worker's Party won a further 4 seats in the 2020 General Election. The WP's numbers in Parliament are still small and lack the one-third required to break the PAP's parliamentary supermajority, which allows the PAP the ability to amend the Constitution with few obstacles.</p>
            <div class='vegaChart' id="vega-party-vis"></div>
          </div>
        </div>

        <div class='step' data-step='9'>
          <div class='step-text'>
            <h2>Beyond party affliation, is there diversity in Parliament?</h2>
            <p>Parliament should be representative to offer the electorate a sense of belonging and inclusion. It should draw upon the widest possible pools of talent and experience from people and reflect the different gender, age and ethnic groups within society. Based on the subset of attributes of each MP,</p> 
            <ul>
              <li>Gender</li>
              <li>Age</li>
              <li>Ethnicity</li>
              <li>Prior work experience</li>
              <li>Years in Politics</li>
            </ul>
            <p>with the exception of party affliation and constituency representation, a clustering algorithm is applied to group similar MPs, with each attribute having equal weight. A distinct separation of female and male clusters can be observed, but beyond that, there are no large and tight clusters, with only some tight pairs or trios. This can be interpreted to mean that there are few MPs who are similar to one another.</p>
          </div>
        </div>

        <div class='step' data-step='10'>
            <div class='step-text'>
              <p>Chasing after a better proportion of representation alone is not ideal. What matters is that the people Singaporeans have voted for to represent them contribute constructively and voice the concerns of their constituents during Parliament sessions.</p>
              <p style='font-size: 1.6em; font-style: italic;'>“Look at each of the candidate as an individual, understand his background, understand his or her thinking... what they stand for and see how they can make a contribution, rather than pigeonhole anyone of them just because of a single dimension of their background.”</p>
              <p style='text-align: right; font-style: italic; font-size: 1em; padding: 0px; margin: 0px'>Mr Chan Chun Sing, Minister for Trade & Industry</p>
              <p>Hopefully, with this diverse group of members, a more robust debate and exchange of alternative perspectives will flow and lead to better policy-making.</p>
            </div>
        </div>

        <div class='step' data-step='11'>
        </div>

        <div class='footer'>
          <div class='credits'>
            <p>Credits</p>
            <h4>Design & Development: Diana Ow</h4>
          </div>
          <div class='references'>
            <p>References</p>
            <h4>Glossary, <a href="https://www.parliament.gov.sg/parliamentary-business/glossary">Singapore Parliament</a>, 28 July 2020</h4>
            <h4>List of Current MPs, <a href="https://www.parliament.gov.sg/mps/list-of-current-mps">Singapore Parliament</a>, 22 May 2020</h4>
            <h4>Goh Chok Tong (Deputy Prime Minister and Minister for Defence), speech during the Second Reading of the Parliamentary Elections (Amendment) Bill, Singapore Parliamentary Debates, Official Report (11 January 1988), vol. 50, col. 180, 183-184.</h4>
            <h4>Bilveer Singh (2006), Politics and Governance in Singapore: An Introduction, Singapore: McGraw-Hill, ISBN 978-0-07-126184-5.</h4>
            <h4>Li Xueying, "GRCs make it easier to find top talent: SM: Without good chance of winning at polls, they might not be willing to risk careers for politics", The Straits Times. 27 June 2006.</p>
            <h4>Linette Lai, "PM Lee Hsien Loong announces new Cabinet line-up; changes at the helm for 6 ministries", The Straits Times. 1 August 2020.</h4>
          </div>

      </article>
    </section>
  </main>

<script>

  var TRANSFORM_LEFT = (window.innerWidth <= 1800 ? 200 : 300)

  // Ensure that page is flushed to top everytime a user refreshes the page
  window.onbeforeunload = function () {
    window.scrollTo(0, 0);
  }

  var show_legend = false
  // initialize scrollama
  var scroller = scrollama();

  var main = d3.select('main')
  var scrolly = main.select('#scrolly');
  var chart = scrolly.select('#chart');
  var article = scrolly.select('article');
  var step = article.selectAll('.step');

  var canvasDim = { width: window.innerWidth, height: window.innerHeight}
  var margin = {top: 20, right: 0, bottom: 0, left: 0}
  var width = canvasDim.width - margin.left - margin.right 
  var height = canvasDim.height - margin.top - margin.bottom 

  var svg = chart.append("svg")
      .attr("width", width + margin.left + margin.right)
      .attr("height", height + margin.top + margin.bottom)

  var g = svg.append("g")
      .attr("transform", "translate(" + margin.left + "," + margin.top + ")")

  var map = g.append("g").attr("id", "map")
              .attr("transform", "translate(" + (-width/4) + "," + 0 + ")")

  var bubbles_explore = g.append("g").attr("id", "bubbles_explore")
    .attr("transform", "translate(" + (-width/4) + "," + 0 + ")")

  var svgLegend = g.append("g").attr("id", "legend")
              .attr("transform", "translate(" + (width-330).toString() + "," + (height-260) + ")")

  var centroids = []

  let radius = window.innerWidth <=1050 ? 5 : 17.5

  let forceCollide = d3.forceCollide()
      .radius(function(d) { return radius + 5; })

  var category = {
   'Group 1': ["Defence", "Foreign Affairs"],
   'Group 2': ["Health"], 
   'Group 3': ["Transport"], 
   'Group 4': ["Sustainability and the Environment", 
               "Social & Family Development", 
               "Communications & Information", 
               "Culture, Community and Youth", 
               "Education"],
   'Group 5': ["Trade and Industry", "Manpower", "Finance"], 
   'Group 6': ["PMO"],
   'Group 7': ["Law", "National Development", "Home Affairs"] 
  }

  var categoryList = Object.values(category).flat()
  var occupationList = ['Public Service (Labour)', 'IT/Engineering', 'Infrastructure (Transport/Telecomms/Real Estate)', 'Public Service (Multiple Stat Boards)', 'Social Enterprise/Charity', 'SAF/SPF/SCDF', 'Law', 'Education', 'Finance', 'Entrepreneur', 'Public Service (Finance)', 'Biz Dev', 'Specialist - Healthcare', 'Public Service (Social/Healthcare)', 'Public Service / Govt-linked (Biz Dev)', 'Other(HR/Management)']

  // var color = {
  //   'Group 1' : "#f94144", 
  //   "Group 2" : "#f20089", 
  //   "Group 3": "#f8961e", 
  //   "Group 4" : "#ffd500", 
  //   "Group 5" : "#90be6d", 
  //   "Group 6" : "#2d00f7", 
  //   'Group 7' : "#7209b7"
  // }

  var color = {
    'Group 1' : "#f7524f", 
    "Group 2" : "#FEC7C4", 
    "Group 3": "#4561cc", 
    "Group 4" : "#f8bc2e", 
    "Group 5" : "#696969",
    "Group 6" : "#a71172", 
    'Group 7' : "#2b8da5"
  }

  var widths = {
    'Prime Minister' : 6, 
    "Deputy Prime Minister" : 5.5,
    "Senior Minister" : 5.5,
    "Minister" : 5.5,  
    "Senior Minister of State": 3.5, 
    "Minister of State" : 3, 
    "Senior Parliamentary Secretary" : 1.5,
    "Parliamentary Secretaries" : 1
  }

  var colorScale = d3.scaleOrdinal()
    .domain(Object.keys(color))
    .range(Object.values(color))

  var widthScale = d3.scaleOrdinal()
    .domain(Object.keys(widths))
    .range(Object.values(widths))

  drawLegend(svgLegend)

  /////////////////////// Draw Legend //////////////////////////
  function drawLegend(svgLegend){

    svgLegend.attr("display", "none")

    svgLegend.append('rect')
      .attr("transform", 'translate(-40,-55)')
      .attr('fill', '#fbf5e9')
      .attr('width', 300)
      .attr('height', 500)

    svgLegend.append('text')
      .attr("transform", 'translate(0,-30)')
      .attr('font-weight', 'bold')
      .text('Ministries')

    var legend = svgLegend.selectAll('.legend')
      .data(Object.entries(color))
      .enter().append('g')
        .attr("class", "legend")
        .attr("transform", function (d, i) {return "translate(0," + getY(i)+ ")"})
        
    legend.append("circle")
        .attr("class", "legend-node")
        .attr("cx", -20)
        .attr("cy", -10/2)
        .attr("r", 10)
        .style("fill", d=>colorScale(d))

    legend.append("text")
        .attr("class", "legend-text")
        .style("fill", "black")
        .style("font-size", 12)
        .text(d=> category[d[0]])
        .call(wrap, 300);

    function getY(i){
      if(i<=3){
        return i*25
      } else if(i==3){
        return i*50
      } else {
        return (i*25) + 30
      }
    }
  }


  /////////////////////// Draw Map (with labels) //////////////////////////
  function drawMap(data, projection) {

    var path = d3.geoPath()
       .projection(projection)

    // draw a path for each feature/country
    map
       .selectAll("path")
       .data(data)
       .enter().append("path")
       .attr("d", path)
       .attr('id', d=> 'map-' + findID(d))
       .attr("class", "constituencies")
       .attr('fill', 'transparent')
       .attr('stroke', 'black')
       .attr('stroke-width', 0.2)
       .attr('stroke-opacity', 0.5)
       .attr("transform", "translate(" + TRANSFORM_LEFT + "," + 20 + ")")

    map
       .selectAll("text")
       .data(data)
       .enter().append("text")
       .attr('id', d=> 'map-label-' + findID(d))
       .attr("class", "constituencies-labels")
       .attr("transform", "translate(" + ((width/2)+(width/4)).toString() + "," + 20 + ")")
       // .attr("transform", function(d) {
       //    let centroid = path.centroid(d)
       //    return (
       //       "translate(" + centroid[0] + "," + centroid[1] + ")" // centroid of countries
       //    );
       // })
       .attr('text-anchor', 'middle')
       .attr('font-weight', 'bold')
       .attr('fill', 'black')
       .attr('opacity', 0)
       .text(d=>d.properties['Name'])

    d3.selectAll("path.constituencies")
     .on('mouseover', function(d){
        d3.select('#map-label-'+ findID(d)).attr('opacity', 1)
        d3.select(this).attr('stroke-opacity', 0.5)
     })
     .on('mouseout', function(d){
        d3.select('#map-label-'+ findID(d)).attr('opacity', 0)
        d3.select(this).attr('stroke-opacity', 0.5)
        d3.select(".tooltip").style("opacity", 0)

     })

  }

  function simulateStatic(nodes, simulation, opacity) {

    simulation.stop();

    while (simulation.alpha() > simulation.alphaMin()) {
      simulation.tick();
    }

    updateCircles(nodes, 400, opacity)

  }

  /////////////////////// Update circle (with image) location and attributes //////////////////////////
  function updateCircles(data, DELAY, opacity){

    circles = bubbles_explore.selectAll("g.nodegroup").data(data, (d,i)=>d['key'])

    let entered_circles = circles.enter().append("g")
      .attr('class', 'nodegroup')
      .attr('id', d => 'node-' + d.Title_1.trim().replaceAll(' ', '_'))
      .attr('transform', d=> { return 'translate(' + d.x + "," + d.y + ")" })
      .style('opacity', opacity)
      .attr('cursor', 'pointer')
      .each(function (d) {
        NodePieBuilder.drawNodePie(d3.select(this), d.pieChart, {
          radius: radius + widthScale(d.Title_1)
        });
      })
      .on('mouseover', function(d){

        let items = []
        if(d.Ministry_1){ items.push(d.Ministry_1) }
        if(d.Ministry_2){ items.push(d.Ministry_2) }
        if(d.Ministry_3){ items.push(d.Ministry_3) }

        let keywordList = "<p>";
        for(var i = 0; i < items.length; i++){
          keywordList += "<span class='mini-button'>" + items[i] + "</span>"
        }
        keywordList += "</p>";

        let exp = []
        if(d.First_Occupation){ exp.push(d.First_Occupation) }
        if(d.First_Occupation !== d.Previous_Occupation){
          exp.push(d.Previous_Occupation) 
        }
        
        let occupationList = "<p> Work Experience: ";
        for(var i = 0; i < exp.length; i++){
          occupationList += "<span style='padding: 2px 6px'>" + exp[i] + "</span>"
        }
        occupationList += "</p>";

        let ID = d['Division'].replace(' ', '_').toUpperCase()
        d3.select('#map-label-'+ ID).attr('opacity', 1)
        d3.select('#map-'+ ID).attr('stroke-opacity', 1)
        d3.select(".tooltip")
          .html(
            "<div style='padding: 10px 20px 10px 0px'><img width='140px' src=" + `./images/${d.newName}.jpg` + "></div><div>" + 
            "<h3>" + d.Name + "</h3><p>" + 
            "Title: <span>" + d.Title_1 + "</span></p><p>" +
            "Party: <span>" + d.Party + "</span></p><p>" + 
            "Constituency: <span>" + d.Division + "</span></p><p>" + 
            "Gender: <span>" + d.Gender + "</span></p><p>" + 
            "Age: <span>" + d.Age + "</span></p><p>" + 
            "Ethnicity: <span>" + d.Ethnicity + "</span></p><p>" +
            "No. of terms: <span>" + d.sessions_group + "</span></p>" + 
            occupationList + keywordList
          )
          //.style("left", (d3.event.clientX + 25).toString() + "px")
          //.style("top", (d3.event.clientY - 70).toString() + "px")
          .style("opacity", 1)
      })
      .on('mouseout', function(d){
        let ID = d['Division'].replace(' ', '_').toUpperCase()
        d3.select('#map-label-'+ ID).attr('opacity', 0)
        d3.select('#map-'+ ID).attr('stroke-opacity', 0)
        d3.select(".tooltip").style("opacity", 0)
      })

    const imageAccessor = d => `./images/${d.newName}.jpg`
    const fillAccessor = d => `url(#image-${d.newName})`

    const defs = entered_circles.append("defs");

    defs
      .append('pattern')
        .attr("id", d => "image-" + d['newName'])
        .attr("width", 1)
        .attr("height", 1)
      .append("svg:image")
        .attr("xlink:href", d => imageAccessor(d))
        .attr("width", 35)
        .attr("preserveAspectRatio", "xMidYMid slice")
        
    entered_circles.append("circle").attr('class', 'bubble')
      .attr('r', radius)
      .attr('stroke', 'black')
      .attr('stroke-width', d => d['Type.1'] == 'Cabinet' ? '0px' : '0px')
      .attr('fill', d => window.innerWidth <= 1050 ? 'black' : fillAccessor(d))
      .style('opacity', 0)

    circles.merge(entered_circles)        
      .transition().ease(d3.easeCubicOut).duration(750).delay(DELAY)
      .attr('transform', d=> { return 'translate(' + d.x + "," + d.y + ")" })
      .style('opacity', opacity)

    circles.merge(entered_circles).selectAll('.bubble')
      .transition().duration(750)
      .style('opacity', 1)

    circles.exit()
      .transition().duration(250)
      .style('opacity', 0)
      .remove()
    
  }

  function drawClustersOnMap(data, projection, coords, opacity) {

    data.forEach(d=>{
      let point = projection([+d[coords[0]], +d[coords[1]]])
      d.x = point[0] + TRANSFORM_LEFT
      d.y = point[1]
    })

    var simulation = d3.forceSimulation()
      .nodes(data)
      .force("collide", forceCollide)
      .force('charge', d3.forceManyBody().strength(-10))
      .force("x", d3.forceX(function (d) { return d.x }).strength(1))
      .force("y", d3.forceY(function (d) { return d.y }).strength(1))

    simulateStatic(data, simulation, opacity)

  }


  function drawGrid(data, col) {

    var modsPerRow = window.innerWidth <= 1050 ? 4 : 6
    var modsSize = (width) / modsPerRow
    var modulePosition = []
    for(var i = occupationList.length; i >=0 ; i--) {
      var rowNumber = Math.floor(i / modsPerRow)
      modulePosition.push(
      { 
        "key": occupationList[i],
        "coordinates" : { 
          x: width - ((i % modsPerRow) * modsSize) - modsSize/2,
          y: resizeY()
        }
      })
    }

    function resizeY(){
      if( window.innerHeight > window.innerWidth){
        return -(rowNumber + 1) * (modsSize) + height
      } else {
        if(window.innerWidth <= 1050){
          return -(rowNumber + 1) * (modsSize/2) + height
        } else {
          return -(rowNumber + 1) * (modsSize) + height + modsSize/2
        }
      }
    }

    let nodes = createNodes(modulePosition, data) 

    let modulePosTexts = []
    modulePosition.map(d=>{
      modulePosTexts.push({
          key: d.key,
          x: d.coordinates.x - (window.innerWidth <= 1050 ? 60 : 40), 
          y: d.coordinates.y - (window.innerWidth <= 1050 ? 60 : 110)
      })
    })

    updateTexts(modulePosTexts, false)

    var simulation = d3.forceSimulation()
      .nodes(nodes)
      .force("collide", forceCollide)
      .force('charge', d3.forceManyBody().strength(-10))
      .force("x", d3.forceX(function (d) { return d.x+width/4 }))
      .force("y", d3.forceY(function (d) { return d.y }))

    simulateStatic(nodes, simulation, 1)

    ////////////////////////////////// Create nodes //////////////////////////////
    function createNodes(focis, data) {

      var n = []
      data.map((d,i)=> {
        let F = focis.find(f=>f.key == d[col]) 
        n.push({
          ...d,
          key: d['newName'] + '-' + d.Ministry_1, // unique index for each node
          x: F.coordinates.x,
          y: F.coordinates.y,
        })
      })

      return n

    }

  }

  function drawFocisMinistry(data) {

    var Foci_new = onFociCountChange(null, categoryList, 4.9)
    var FociText = onFociCountChange(null, categoryList, 6.3)

    let dataFiltered = data.filter(d=>d['Type.1'] == 'Cabinet')
    let nodes = createNodes(Foci_new, dataFiltered) 
    updateTexts(FociText, true) 

    var simulation = d3.forceSimulation()
      .nodes(nodes)
      .force("collide", forceCollide)
      .force('charge', d3.forceManyBody().strength(-10))
      .force("x", d3.forceX(function (d) { return d.x+width/4 }))
      .force("y", d3.forceY(function (d) { return d.y }))

    simulateStatic(nodes, simulation, 1)

    // setTimeout(function(){

    //   let nodes = createNodes(Foci_new, data) 

    //   simulation = d3.forceSimulation()
    //     .nodes(nodes)
    //     .force("collide", forceCollide)
    //     .force('charge', d3.forceManyBody().strength(-10))
    //     .force("x", d3.forceX(function (d) { return d.x }))
    //     .force("y", d3.forceY(function (d) { return d.y }))

    //   simulateStatic(nodes, simulation)

    // }, 3000)

    ////////////////////////////////// Create nodes //////////////////////////////
    function createNodes(focis, data) {

      var n = []
      data.map((d,i)=> {
        let F = focis.find(f=>f.key == d.Ministry_1) || [{x: width/2, y: height/2, color: "#E47D06"}]
        n.push({
          ...d,
          key: d['newName'] + '-' + d.Ministry_1, // unique index for each node
          x: F.x,
          y: F.y,
        })
      })
      let data_2 = data.filter(d=>d.Ministry_2)
      data_2.map((d,i)=> {
        let F = focis.find(f=>f.key == d.Ministry_2) || [{x: width/2, y: height/2, color: "#E47D06"}]
        n.push({
          ...d,
          key: d['newName'] + '-' + d.Ministry_2, // unique index for each node
          x: F.x,
          y: F.y
        })
      })
      let data_3 = data.filter(d=>d.Ministry_3)
      data_3.map((d,i)=> {
        let F = focis.find(f=>f.key == d.Ministry_3) || [{x: width/2, y: height/2, color: "#E47D06"}]
        n.push({
          ...d,
          key: d['newName'] + '-' + d.Ministry_3, // unique index for each node
          x: F.x,
          y: F.y
        })
      })

      return n

    }

  }

  function drawCategory(data, col, categoryList) {

    ///////////////////////////////////////////////////////////////////////////
    ///////////////////////////// Create scales ///////////////////////////////
    ///////////////////////////////////////////////////////////////////////////
    let dataGrp = d3.nest()
      .key(d=>d[col])
      .entries(data)

    var Foci_new = onFociCountChange(dataGrp, categoryList, 6.8)
    var FociText = onFociCountChange(dataGrp, categoryList, 6.8)

    let nodes = createNodes(Foci_new, data, col) 

    updateTexts1(FociText) 

    var simulation = d3.forceSimulation()
      .nodes(nodes)
      .force("collide", forceCollide)
      .force('charge', d3.forceManyBody().strength(-10))
      .force("x", d3.forceX(function (d) { return d.x+width/3+80 }))
      .force("y", d3.forceY(function (d) { return d.y }))

    simulateStatic(nodes, simulation, 1)

    ////////////////////////////////// Create nodes //////////////////////////////
    function createNodes(focis, data, col) {

      var n = []
      data.map((d,i)=> {
        let F = focis.find(f=>f.key == d[col]) || [{x: width/2, y: height/2, color: "#E47D06"}]
        n.push({
          ...d,
          key: d['newName'] + '-' + d.Ministry_1, // unique index for each node
          x: F.x,
          y: F.y,
        })
      })
      return n

    }
  }

  window.onload = function () {
    if(window.innerWidth > 700){

       //Load data
        Promise.all([
          d3.csv("./data/mps_constituencies.csv"),
          d3.json("./data/electoral-boundary-2020.json"),
          d3.json("./data/GE2020.json")
        ]).then(function(data) {
          
          let data0 = data[0]
          let data1 = data[1]
          let data2 = data[2]

          data0.forEach(d=>{
            d.key = d['newName'] + '-' + d.Ministry_1
            d.age_group = getAgeGrp(+d.Age)
            d.sessions_group = getSessionsGrp(+d.Years_In_Politics)
            if(d.Ministry_1 && d.Ministry_2 && d.Ministry_3){
              d.pieChart = [
                {group: getKeyByValue(category, d.Ministry_1), percent: 100/3},
                {group: getKeyByValue(category, d.Ministry_2), percent: 100/3},
                {group: getKeyByValue(category, d.Ministry_3), percent: 100/3}
              ]
            } else if (d.Ministry_1 && d.Ministry_2){
              d.pieChart = [
                {group: getKeyByValue(category, d.Ministry_1), percent: 100/2},
                {group: getKeyByValue(category, d.Ministry_2), percent: 100/2}
              ]
            } else if(d.Ministry_1){
              d.pieChart = [
                {group: getKeyByValue(category, d.Ministry_1), percent: 100}
              ]
            } else {
              d.pieChart = []
            }
          })

          let fixed = data1.features.map(function(f) {
            return turf.rewind(f,{reverse:true});
          })

          let projection = d3.geoMercator()
            .fitSize([width*1.2,height*1.2],{"type": "FeatureCollection","features":fixed})

          let fixed2 = data2.features.map(function(f) {
            return turf.rewind(f,{reverse:true});
          })

          let projection2 = d3.geoMercator()
            .fitSize([width*1.2,height*1.2],{"type": "FeatureCollection","features":fixed2})
          
          // 1. force a resize on load to ensure proper dimensions are sent to scrollama
          handleResize();

          // 2. setup the scroller passing options
          //    this will also initialize trigger observations
          // 3. bind scrollama event handlers (this can be chained like below)
          scroller.setup({
            step: '#scrolly article .step',
            offset: 0.25,
            debug: false,
            progress: true,
            threshold: 1
          })
          .onStepEnter(handleStepEnter)

          // setup resize event
          window.addEventListener('resize', handleResize);

          // render on initial page load
          //drawMap(fixed, projection)
          //drawClustersOnMap(data0, projection
          drawClustersOnMap(data0, projection2, ['lat_ward', 'lon_ward'], 0.3)

          d3.select(".foci-view")
            .on("click", function() {
              clear()
              drawFocisMinistry(data0)
            })

          d3.select(".ethnicity-view")
            .on("click", function() {
              clear()
              drawCategory(data0, 'Ethnicity', ['Malay', 'Eurasian', 'Chinese', 'Indian']) 
            })

          d3.select(".gender-view")
            .on("click", function() {
              clear()
              drawCategory(data0, 'Gender', ['Female', 'Male']) 
            })

          d3.select(".party-view")
            .on("click", function() {
              clear()
              drawCategory(data0, 'Party', ["People's Action Party", "Workers' Party"]) 
            })

          d3.select(".occupation1-view")
            .on("click", function() {
              clear()
              drawGrid(data0, 'First_Occupation')
            })

          d3.select(".occupation2-view")
            .on("click", function() {
              clear()
              drawGrid(data0, 'Previous_Occupation')
            })

          d3.select(".age-view")
            .on("click", function() {
              clear()
              let options = {
                radius: radius*1.25,
                tilesPerRow: 3,
                width: width,
                height: height-radius,
                leftBuffer: 0,
                bottomBuffer: 0,
                category: {'color': undefined, 'sort_list': d3.range(d3.extent(data, d=>d.age)), 'sort_category': 'Age'}
              }
              let nodes = createDots(data0, 'bar', 'age_group', "", ['Less than 35', '35 - 40', '40 - 45', '45 - 50', '50 - 55', '55 - 60', '60 - 65', 'More than 65'], "", options)
              nodes.dots.forEach(d=>{
                d.x = d.x + width/4
              })
              updateCircles(nodes.dots, (d,i)=>50*i, 1)
              updateTexts1(nodes.labels.filter(d=>d.type === 'xaxis_label')) 
            })

          d3.select(".scatter-view")
            .on("click", function() {
              clear()
              let data = createScatter(data0, {x: 'Years_In_Politics', y: 'Age', rangeX: [width/3+40, width+width/6], rangeY: [height-40, 20], show_axis: true})
              var simulation = d3.forceSimulation()
                .nodes(data)
                .force("collide", forceCollide)
                .force('charge', d3.forceManyBody().strength(-10))
                .force("x", d3.forceX(function (d) { return d.x }).strength(1))
                .force("y", d3.forceY(function (d) { return d.y }).strength(1))

              simulateStatic(data, simulation, 1) 
            })

          d3.select(".map-view")
            .on("click", function() { 
              clear()
              drawMap(fixed, projection)
              drawClustersOnMap(data0, projection, ['lat', 'long'], 1)
            })
         
          d3.select(".tsne-view")
            .on("click", function() {
              clear()
              let data = createScatter(data0, {x: 'X1', y: 'Y1', rangeX: [width/3, width+width/5], rangeY: [height-40, 40], show_axis: false})
              updateCircles(data, 400, 1)
            })

          d3.select(".legend-view")
            .on("click", function() {
              show_legend = !show_legend
              if(show_legend){
                d3.selectAll("#legend")
                  .attr("display", "block")
                  //.attr('opacity', 1)
              } else {
                d3.selectAll("#legend")
                  .attr("display", "none")
                  //.attr('opacity', 0)
              }
            })

          function clear() {
            map.selectAll('path').remove()
            map.selectAll(".constituencies-labels").remove()
            bubbles_explore.selectAll(".fociText").remove()
            bubbles_explore.selectAll(".label-shape").remove()
            bubbles_explore.selectAll(".label-text").remove()
            bubbles_explore.selectAll(".scatter_x_axis").remove()
            bubbles_explore.selectAll(".scatter_y_axis").remove()
          }

          ///////////////////////////////////////////////////////////////////////////
          ////////////////////////// Scrollama event handlers ///////////////////////
          ///////////////////////////////////////////////////////////////////////////
          function handleResize() {

            // 1. update height of step elements
            var stepH = Math.floor(window.innerHeight);
            step.style('height', stepH + 'px');
            var figureHeight = window.innerHeight
            var figureMarginTop = (window.innerHeight - figureHeight) / 2  
            chart
              .style('height', figureHeight + 'px')
              .style('top', figureMarginTop + 'px');
            // 3. tell scrollama to update new element dimensions
            scroller.resize();

          }

          function handleStepEnter(response) {

            // response = { element, direction, index }
            // fade in current step
            step.classed('is-active', function (d, i) {
                return i === response.index;
            })

            if (response.index === 0) { 

              d3.selectAll(".div-legend").style('display', 'none')
              clear()
              drawMap(fixed2, projection2)
              drawClustersOnMap(data0, projection2, ['lat_ward', 'lon_ward'], 0.3)

              scroller.onStepProgress(handleStepProgress)

            } else if (response.index === 1) { 

              d3.selectAll(".div-legend").style('display', 'block')
              d3.selectAll('#node-Member_of_Parliament').style('opacity', 1)
              
            } else if (response.index === 2) { 

              clear()
              drawMap(fixed, projection)
              drawClustersOnMap(data0, projection, ['lat', 'long'], 1)

            } else if (response.index === 3) { 

              clear()
              drawCategory(data0, 'Ethnicity', ['Malay', 'Eurasian', 'Chinese', 'Indian']) 

            } else if (response.index === 4) {

              clear()
              drawCategory(data0, 'Gender', ['Female', 'Male']) 

            } else if (response.index === 5) { 

              clear()
              let data = createScatter(data0, {x: 'Years_In_Politics', y: 'Age', rangeX: [width/3+40, width+width/6], rangeY: [height-40, 20], show_axis: true})
              var simulation = d3.forceSimulation()
                .nodes(data)
                .force("collide", forceCollide)
                .force('charge', d3.forceManyBody().strength(-10))
                .force("x", d3.forceX(function (d) { return d.x }).strength(1))
                .force("y", d3.forceY(function (d) { return d.y }).strength(1))

              simulateStatic(data, simulation, 1) 

            } else if (response.index === 6) { 

              clear()
              drawGrid(data0, 'First_Occupation')

            } else if (response.index === 7) { 

              clear()
              drawGrid(data0, 'Previous_Occupation')

            } else if (response.index === 8) { 

              clear()
              drawCategory(data0, 'Party', ["People's Action Party", "Workers' Party"]) 

            } else if (response.index === 9) { 

              clear()
              let data = createScatter(data0, {x: 'X1', y: 'Y1', rangeX: [width/3, width+width/5], rangeY: [height-40, 40], show_axis: false})
              updateCircles(data, 400, 1)

              d3.selectAll('.panel').style('display', 'none')
              //d3.selectAll("#legend").attr('opacity', 0)

            } else if (response.index === 10) { 

              let p1 = data0.find(d=>d.Name === 'Teo Chee Hean')
              let p2 = data0.find(d=>d.Name === 'Baey Yam Keng')
              let p3 = data0.find(d=>d.Name === 'Tan Kiat How')
              let p4 = data0.find(d=>d.Name === 'Vikram Nair')
              let p5 = data0.find(d=>d.Name === 'Vivian Balakrishnan')
              let p6 = data0.find(d=>d.Name === 'Nadia Ahmad Samdin')
              let p7 = data0.find(d=>d.Name === 'Denise Phua')

              let annotations = resizeAnnotations()
              createAnnotations(annotations)

              d3.selectAll('.panel').style('display', 'block')
              //d3.selectAll("#legend").attr('opacity', 1)

              function resizeAnnotations(){
                if( window.innerHeight > window.innerWidth){
                  return [
                      {label: 'Men from the military or police', x: p1.x+30, y: p1.y+60, rx: 160/2, ry: 130*1.3}, 
                      {label: 'Public Service scholars', x: p2.x, y: p2.y, rx: 80/2, ry: 80},
                      {label: 'New male MPs', x: p3.x, y: p3.y, rx: 200/2, ry: 120*1.2},
                      {label: 'Male lawyers', x: p4.x+15, y: p4.y-50, rx: 160/2, ry: 145*1.3},
                      {label: 'Veteran Ministers', x: p5.x+10, y: p5.y, rx: 150/2, ry: 90},
                      {label: 'Young female laywers', x: p6.x, y: p6.y, rx: 80/2, ry: 80},
                      {label: 'Veteran female MPs', x: p7.x, y: p7.y+20, rx: 130/2, ry: 70}
                  ]
                } else {
                  if(window.innerWidth >= 1600){
                    return [
                      {label: 'Men from the military or police', x: p1.x+50, y: p1.y+50, rx: 200, ry: 180}, 
                      {label: 'Public Service scholars', x: p2.x, y: p2.y, rx: 80, ry: 95},
                      {label: 'New male MPs', x: p3.x, y: p3.y, rx: 220, ry: 150},
                      {label: 'Male lawyers', x: p4.x+20, y: p4.y-50, rx: 180, ry: 190},
                      {label: 'Veteran Ministers', x: p5.x+50, y: p5.y, rx: 180, ry: 90},
                      {label: 'Young female laywers', x: p6.x, y: p6.y, rx: 130, ry: 80},
                      {label: 'Veteran female MPs', x: p7.x+30, y: p7.y, rx: 170, ry: 100}
                    ]
                  } else if(window.innerWidth <= 1050){
                    return [
                      {label: 'Men from the military or police', x: p1.x+40, y: p1.y+40, rx: 110, ry: 120}, 
                      {label: 'Public Service scholars', x: p2.x, y: p2.y, rx: 80, ry: 80},
                      {label: 'New male MPs', x: p3.x, y: p3.y, rx: 140, ry: 100},
                      {label: 'Male lawyers', x: p4.x+15, y: p4.y-30, rx: 100, ry: 145},
                      {label: 'Veteran Ministers', x: p5.x+20, y: p5.y, rx: 110, ry: 100},
                      {label: 'Young female laywers', x: p6.x, y: p6.y, rx: 80, ry: 70},
                      {label: 'Veteran female MPs', x: p7.x, y: p7.y+20, rx: 130, ry: 70}
                    ]
                  } else {
                    return [
                      {label: 'Men from the military or police', x: p1.x+40, y: p1.y+20, rx: 160, ry: 130}, 
                      {label: 'Public Service scholars', x: p2.x, y: p2.y, rx: 80, ry: 80},
                      {label: 'New male MPs', x: p3.x, y: p3.y, rx: 200, ry: 120},
                      {label: 'Male lawyers', x: p4.x+15, y: p4.y-30, rx: 140, ry: 145},
                      {label: 'Veteran Ministers', x: p5.x+30, y: p5.y, rx: 150, ry: 90},
                      {label: 'Young female laywers', x: p6.x, y: p6.y, rx: 80, ry: 80},
                      {label: 'Veteran female MPs', x: p7.x, y: p7.y+20, rx: 130, ry: 70}
                    ]
                  }
                }
              }
            } 
          }

          function handleStepExit(response) {
            response.element.classList.remove('is-active');
          }

          function handleStepProgress(response) {

            if (response.index === 0) {
              if(response.progress > 0.1 & response.progress <= 0.25) {
                d3.selectAll('#node-Prime_Minister').style('opacity', 1)
              } else if(response.progress > 0.25 & response.progress <= 0.5) {
                d3.selectAll('#node-Prime_Minister').style('opacity', 1)
                d3.selectAll('#node-Senior_Minister').style('opacity', 1)
                d3.selectAll('#node-Minister').style('opacity', 1)
              } else if(response.progress > 0.5 & response.progress <= 0.75) {
                d3.selectAll('#node-Prime_Minister').style('opacity', 1)
                d3.selectAll('#node-Senior_Minister').style('opacity', 1)
                d3.selectAll('#node-Minister').style('opacity', 1)
                d3.selectAll('#node-Senior_Minister_of_State').style('opacity', 1)
                d3.selectAll('#node-Minister_of_State').style('opacity', 1)
              } else if(response.progress > 0.75) {
                d3.selectAll('#node-Prime_Minister').style('opacity', 1)
                d3.selectAll('#node-Senior_Minister').style('opacity', 1)
                d3.selectAll('#node-Minister').style('opacity', 1)
                d3.selectAll('#node-Senior_Minister_of_State').style('opacity', 1)
                d3.selectAll('#node-Minister_of_State').style('opacity', 1)
                d3.selectAll('#node-Senior_Parliamentary_Secretary').style('opacity', 1)
                d3.selectAll('#node-Parliamentary_Secretaries').style('opacity', 1)
              } else if(response.progress <= 0.1){
                d3.selectAll('#node-Prime_Minister').style('opacity', 1)
                d3.selectAll('g.nodegroup').style('opacity', 0.3)
              }
            }

          }

        })

    }
  }

///////////////////////////////////////////////////////////////////////////
///////////////////////////// Helper functions ////////////////////////////
///////////////////////////////////////////////////////////////////////////
function getAgeGrp(d){
  if(d<=35){
    return 'Less than 35'
  } else if(d>35 && d<=40){
    return '35 - 40'
  } else if(d>40 && d<=45){
    return '40 - 45'
  } else if(d>45 && d<=50){
    return '45 - 50'
  } else if(d>50 && d<=55){
    return '50 - 55'
  } else if(d>55 && d<=60){
    return '55 - 60'
  } else if(d>60 && d<=65){
    return '60 - 65'
  } else if(d>65){
    return 'More than 65'
  }
}

function getSessionsGrp(d){
  if(d==0){
    return '1'
  } else if(d>0 && d<=5){
    return '2'
  } else if(d>5 && d<=9){
    return '3'
  } else if(d>9 && d<=14){
    return '4'
  } else if(d>14 && d<=19){
    return '5'
  } else if(d>19){
    return 'More than 5'
  } 
}

function createAnnotations(annotations) {

    let annot = bubbles_explore.append("g")
      .attr("class", "scatter_annotations")

    annot.selectAll('ellipse')
      .data(annotations)
      .enter()
      .append("ellipse")
        .attr("class", "label-shape")
        .attr("cx", d=>d.x)
        .attr("cy", d=>d.y)
        .attr("rx", d=>d.rx)
        .attr("ry", d=>d.ry)
        .attr('fill', 'none')
        .attr('stroke', 'black')
        .attr('stroke-dasharray', "4 1")
        .attr('opacity', 0)
        .transition().duration(350)
        .attr('opacity', 1)

    annot.selectAll('text')
      .data(annotations)
      .enter()
      .append("text")
        .attr("class", "label-text")
        .attr("x", d=>d.x)
        .attr("y", d=>d.y-d.ry-4)
        .attr('font-size', '10px')
        .attr('text-anchor', 'middle')
        .text(d=>d.label)
        .attr('opacity', 0)
        .transition().duration(350)
        .attr('opacity', 1)

}

function createScatter(data, attr) {

  let xScale = d3.scaleLinear()
      .range(attr['rangeX'])
      .domain(d3.extent(data, function(d) { return +d[attr['x']]; }))

  let yScale = d3.scaleLinear()
      .range(attr['rangeY'])
      .domain(d3.extent(data, function(d) { return +d[attr['y']]; }))

  data.forEach(d=>{
    d.x = xScale(+d[attr['x']])
    d.y = yScale(+d[attr['y']])
  })

  if(attr['show_axis']){

    let xAxis = d3.axisBottom(xScale);
    let yAxis = d3.axisLeft(yScale);

    bubbles_explore.append("g")
        .attr("class", "scatter_x_axis")
        .attr("transform", `translate(0,${height-30})`)
        .call(xAxis)
      .append("text")
        .attr("class", "label")
        .attr("x", width/2 + width/4)
        .attr("y", 20)
        .attr('fill', 'black')
        .style("text-anchor", "middle")
        .text("Number of years in Parliament");

    bubbles_explore.append("g")
        .attr("class", "scatter_y_axis")
        .attr("transform", `translate(${40+width/4},0)`)
        .call(yAxis)
      .append("text")
        .attr("class", "label")
        .attr("transform", `translate(${-20},${height/2})rotate(-90)`)
        .attr('fill', 'black')
        .attr("dy", ".71em")
        .style("text-anchor", "middle")
        .text("Age")

  }

  return data
}

function updateTexts(focis, adjust) {

  texts = bubbles_explore.selectAll("text.fociText").data(focis, (d,i)=>d['key'])

  let entered_texts = texts.enter().append("text")
    .attr('class', 'fociText')
    .attr('transform', d=> { return 'translate(' + (d.x+width/4).toString() + "," + d.y + ")" })
    .attr('text-anchor', (d,i) => adjust ? alignTexts(i) : 'start')
    .attr('fill',  'black')
    .attr('font-size', '12px')
    .style('opacity', 0)
    .text(d=>d['key'])
    .call(wrap, adjust ? 80 : 140);
    
  texts.merge(entered_texts)         
    .transition().duration(750).delay(400)
    .attr('transform', d=> { return 'translate(' + (d.x+width/4).toString() + "," + d.y + ")" })
    .style('opacity', 1)

  texts.exit()
    .transition().duration(750)
    .style('opacity', 0)
    .remove()

  function alignTexts(i){
    if((i>=13 && i<=16) || (i>=0 && i<=3)){
      return 'end'
    } else if(i===4 || i===12){
      return 'middle'
    } else {
      return 'start'
    }
  }

}

function updateTexts1(focis) {

  function getRadius(count){
    return count ? (count <12 ? ((count*radius)/1.2)-70 : (count*radius/2.5)/2)+60 : 0
  }

  texts = bubbles_explore.selectAll("text.fociText").data(focis, (d,i)=>d['key'])

  let entered_texts = texts.enter().append("g")
    .attr('class', 'fociText')
    .attr('transform', d=> { return 'translate(' + (d.x+width/3+80).toString() + "," + (d.y-getRadius(d.count)).toString() + ")" })
    .style('opacity', 0)

  entered_texts.append('text')
    .attr('text-anchor', 'middle')
    .attr('fill',  'black')
    .attr('font-size', '16px')
    .text(d=>d['key'])
    .call(getBB)
    //.call(wrap, 80);
    
  entered_texts
    .insert("rect", ".fociText text")
    .attr("x", (d) => d.bbox.x-5)
    .attr("y", (d) => d.bbox.y-5)
    .attr("width", function (d) {
      return d.bbox.width + 10 
    })
    .attr("height", function (d) {
      return d.bbox.height + 10
    })
    .style("fill", 'white')

  function getBB(selection) {
    selection.each(function (d) {
      d.bbox = this.getBBox()
    })
  }

  texts.merge(entered_texts)         
    .transition().duration(750).delay(400)
    .attr('transform', d=> { return 'translate(' + (d.x+width/3+80).toString() + "," + (d.y-getRadius(d.count)).toString() + ")" })
    .style('opacity', 1)

  texts.exit()
    .transition().duration(750)
    .style('opacity', 0)
    .remove()

}

////////////////////// Assign focus point of each category //////////////////
function onFociCountChange(data, focis, multiplier) {

    fociCount = focis.length
    foci = {};
    for (let i = 0; i < fociCount; i++) {
        let focus = createFocus(i, focis[i], fociCount, multiplier);
        foci[i] = focus;
    }
    let Foci_new = []
    Object.keys(foci).map(function(key, index) {
       Foci_new.push({
        x: foci[index].x,
        y: foci[index].y,
        key: foci[index].key,
        count: data ? data.find(d=>d.key === foci[index].key).values.length : 0
      })     
    })
    return Foci_new
}

function createFocus(index, key, fociCount, multiplier) {
    let angle = 2 * Math.PI / fociCount * index;
    return {
        key: key,
        index: index,
        angle: angle,
        x: width/multiplier * Math.cos(angle) + width/2,
        y: width/multiplier * Math.sin(angle) + height/2
    };
}

function findID(d){
  return d.properties['Name'].replace(' ', '_').toUpperCase()
  //return d.properties.description.split('<td>')[1].split('</td>')[0]
}

function getKeyByValue(object, value) {
  let key = ""
  let arr = Object.values(object)
  for (i = 0; i < arr.length; i++) {
    if(arr[i].indexOf(value) !== -1){
      key = Object.keys(object).find(k => object[k] === arr[i]);
      break;
    }
  }
  return colorScale(key)
}

function wrap(text, width) {
  text.each(function() {
    var text = d3.select(this),
        words = text.text().split(/\s+/).reverse(),
        word,
        line = [],
        lineNumber = 0,
        lineHeight = 1.2, // ems
        y = text.attr("y"),
        dy = parseFloat(text.attr("dy")) || 0,
        tspan = text.text(null).append("tspan").attr("x", 0).attr("y", y)
    while (word = words.pop()) {
      line.push(word)
      tspan.text(line.join(" "))
      if (tspan.node().getComputedTextLength() > width) {
        line.pop()
        tspan.text(line.join(" "))
        line = [word]
        tspan = text.append("tspan").attr("x", 0).attr("y", `${++lineNumber * lineHeight + dy}em`).text(word)
      }
    }
  })
}

var opt = {"actions":false,
           "renderer": 'svg',
           'theme': 'vox', 
           "padding": {"left": 15, "top": 15, "right": 15, "bottom": 15}
};

var color = ["#f2cc8f","#81b29a","#3d405b","#e07a5f", "#f4f1de", "#cbc0d3"]

// var vegaEthnicityVis = {
//   "$schema": "https://vega.github.io/schema/vega-lite/v4.json",
//   "data": {"url": "data/ethnicity_timeline.csv"},
//   "width": 250, "height": 150,
//   "layer": [
//     {
//       "encoding": {
//         "x": {
//           "field": "Parliament", "type": "quantitative"
//         },
//         "y": {
//           "aggregate": "sum", "field": "value",
//           "axis": {"format": "%", "title": null},
//           "stack": "normalize"
//         },
//         "color": {"field":"Ethnicity", "scale": {"range": color}}
//       },
//       "layer": [
//         {
//           "mark": "bar",
//           "width": {"step": 17},
//         },
//         {
//           "selection": {
//             "tooltip": {
//               "type": "single",
//               "nearest": true,
//               "on": "mouseover",
//               "encodings": [
//                 "x"
//               ],
//               "empty": "none"
//             }
//           },
//           "mark": "point",
//           "encoding": {
//             "opacity": {
//               "condition": {
//                 "selection": "tooltip",
//                 "value": 1
//               },
//               "value": 0
//             }
//           }
//         }
//       ]
//   },
//   {
//     "transform": [
//       {
//         "filter": {
//           "selection": "tooltip"
//         }
//       }
//     ],
//     "layer": [{
//       "mark": {
//        "type": "rule",
//        "color": "gray"
//       },
//       "encoding": {
//         "x": {
//           "type": "quantitative",
//           "field": "Parliament"
//         }
//       }
//     }, {
//       "mark": {
//           "type": "text",
//           "align": "left",
//           "dx": 5,
//           "dy": -5
//       },
//       "encoding": {
//         "text": {
//           "type": "quantitative",
//           "field": "value"
//         },
//         "color": {
//           "type": "nominal",
//           "field": "Ethnicity"
//         },
//         "x": {
//           "type": "quantitative",
//           "field": "Parliament"
//         },
//         "y": {
//           "aggregate": "sum", "field": "value",
//           "axis": {"format": "%", "title": null},
//           "stack": "normalize"
//         }
//       }
//     }]
//   }]
// }


// var vegaGenderVis = {
//   "$schema": "https://vega.github.io/schema/vega-lite/v4.json",
//   "data": {"url": "data/gender_timeline.csv"},
//   "width": 250, "height": 200,
//   "layer": [
//     {
//       "encoding": {
//         "x": {
//           "field": "Parliament", "type": "quantitative"
//         },
//         "y": {
//           "aggregate": "sum", "field": "value",
//           "axis": {"format": "%", "title": null},
//           "stack": "normalize"
//         },
//         "color": {"field":"Gender", "scale": {"range": color}}
//       },
//       "layer": [
//         {
//           "mark": "area"
//         },
//         {
//           "selection": {
//             "tooltip": {
//               "type": "single",
//               "nearest": true,
//               "on": "mouseover",
//               "encodings": [
//                 "x"
//               ],
//               "empty": "none"
//             }
//           },
//           "mark": "point",
//           "encoding": {
//             "opacity": {
//               "condition": {
//                 "selection": "tooltip",
//                 "value": 1
//               },
//               "value": 0
//             }
//           }
//         }
//       ]
//   },
//   {
//     "transform": [
//       {
//         "filter": {
//           "selection": "tooltip"
//         }
//       }
//     ],
//     "layer": [{
//       "mark": {
//        "type": "rule",
//        "color": "gray"
//       },
//       "encoding": {
//         "x": {
//           "type": "quantitative",
//           "field": "Parliament"
//         }
//       }
//     }, {
//       "mark": {
//           "type": "text",
//           "align": "left",
//           "dx": 5,
//           "dy": -5,
//           "format": "%"
//       },
//       "encoding": {
//         "text": {
//           "type": "quantitative",
//           "field": "value"
//         },
//         "color": {
//           "type": "nominal",
//           "field": "Gender"
//         },
//         "x": {
//           "type": "quantitative",
//           "field": "Parliament"
//         },
//         "y": {
//           "aggregate": "sum", "field": "value",
//           "axis": {"format": "%", "title": null},
//           "stack": "normalize"
//         }
//       }
//     }]
//   }]
// }

var vegaEthnicityVis = {
  "$schema": "https://vega.github.io/schema/vega-lite/v4.json",
  "data": {"url": "data/ethnicity_timeline.csv"},
  "width": window.innerWidth <=1050 ? 250 : 280, "height": window.innerWidth <=1050 ? 120 : 150,
  "mark": {"type": "bar", "cornerRadiusTopLeft": 0, "cornerRadiusTopRight": 0, "tooltip": true},
  "encoding": {
    "x": {
      "field": "Parliament", 
      "type": "ordinal", "sort": [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14], 
      "axis": {"labelAngle": 0}
    },
    "y": {"field": "value", "type": "quantitative", "format": ".1%", "axis": {"title": "% of MPs"},  "stack":  "normalize"},
    //"tooltip": [
      //{"field": "Parliament", "type": "quantitative"},
      //{"field": "Ethnicity", "type": "ordinal"},
      //{"field": "value", "type": "quantitative"}
    //],
    "color": {
      "field": "Ethnicity", 
      "scale": {"range": color}, 
      "legend": {"direction": "horizontal", "orient": "bottom"}
    }
  }
}

var vegaGenderVis = {
  "$schema": "https://vega.github.io/schema/vega-lite/v4.json",
  "data": {"url": "data/gender_timeline.csv"},
  "width": window.innerWidth <=1050 ? 250 : 280, "height": window.innerWidth <=1050 ? 120 : 150,
  "mark": {"type": "bar", "cornerRadiusTopLeft": 0, "cornerRadiusTopRight": 0, "tooltip": true},
  "encoding": {
    "x": {
      "field": "Parliament", 
      "type": "ordinal", "sort": [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14], 
      "axis": {"labelAngle": 0}
    },
    "y": {"field": "value", "type": "quantitative", "format": ".1%", "axis": {"title": "% of MPs"},  "stack":  "normalize"},
    //"tooltip": [
      //{"field": "Parliament", "type": "quantitative"},
      //{"field": "Gender", "type": "ordinal"},
      //{"field": "value", "type": "quantitative"}
    //],
    "color": {
      "field": "Gender", 
      "scale": {"range": color}, 
      "legend": {"direction": "horizontal", "orient": "bottom"}
    }
  }
}

var vegaPartyVis = {
  "$schema": "https://vega.github.io/schema/vega-lite/v4.json",
  "data": {"url": "data/party_timeline.csv"},
  "width": window.innerWidth <=1050 ? 250 : 280, "height": window.innerWidth <=1050 ? 140 : 180,
  "mark": {"type": "bar", "cornerRadiusTopLeft": 0, "cornerRadiusTopRight": 0, "tooltip": {"content": "data"}},
  "encoding": {
    "x": {
      "field": "Parliament", 
      "type": "ordinal", "sort": [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14], 
      "axis": {"labelAngle": 0}
    },
    "y": {"field": "value", "type": "quantitative", "axis": {"title": "No. of MPs"}},
    "tooltip": [
      {"field": "Parliament", "type": "quantitative"},
      {"field": "Party", "type": "ordinal"},
      {"field": "value", "type": "quantitative"}
    ],
    "color": {
      "field": "Party", 
      "scale": {"range": color}, 
      "legend": {"direction": "horizontal", "orient": "bottom", "columns": window.innerWidth <=1050 ? 1 : 2}
    }
  }
}

vegaEmbed('#vega-ethnicity-vis', vegaEthnicityVis, opt);
vegaEmbed('#vega-party-vis', vegaPartyVis, opt);
vegaEmbed('#vega-gender-vis', vegaGenderVis, opt);
</script>
<script src="./node-pie.js"></script>
<script src="./dotplot.js"></script>
</body>
</html>